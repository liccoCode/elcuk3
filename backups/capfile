# 自己定义的各种 capistrano 命令

base = "easya.cc"
h_r="root@r.#{base}"
h_e="root@e.#{base}"
h_t="root@t.#{base}"

lobal_backups="/Volumes/wyatt/backups"

role :oAr, h_t, h_e

desc "测试搜索两台远程服务器上的 lib 中是否有 log 文件"
task :search_libs, roles: :redmine do
  run "ls -x1 /usr/lib | grep -i log"
end



namespace :bak do

  desc "对 Elcuk2 主系统的备份"
  task :e, hosts: h_e  do
    run "backup perform -t elcuk"
    system("rsync -axzv --progress --delete #{h_e}:~/backups/elcuk #{lobal_backups}/")
    ['elcuk2-logs', 'elcuk2-data'].each do |dir|
      system("rsync -axzv --progress #{h_e}:~/#{dir} #{lobal_backups}/elcuk/")
    end
  end

  desc "对 OsTicekt 服务器的备份"
  task :t, hosts: h_t do
    # 首先执行两台服务器上的 backup 脚本,然后再对 ~/backups/ 目录进行 rsync 同步
    run "backup perform -t osticket"
    system("rsync -axzv --progress #{h_t}:~/backups/osticket #{lobal_backups}/")
  end

  desc "对 Redmine 服务器的备份"
  task :r, hosts: h_r do
    # 首先执行两台服务器上的 backup 脚本,然后再对 ~/backups/ 目录进行 rsync 同步
    run "backup perform -t redmine"
    system("rsync -axzv --progress #{h_r}:~/backups/redmine #{lobal_backups}/")
  end


end
