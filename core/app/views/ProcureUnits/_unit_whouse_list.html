#{set tr_key: key ? key : 'unit'/}
<table class="table table-condensed table-bordered">
  <tr>
    <th>
      <label class="checkbox">
        <input type="checkbox" id="${key ? tr_key + '_' : ''}checkbox_all" class="${tr_key} checkall">
      </label>
    </th>
    <th style="width:40px;">#</th>
    <th>阶段</th>
    <th width="90px;">操作</th>
    <th>Selling ID</th>
    <th>Sku</th>
    <th style="width:10%;">产品名称</th>
    <th>数量(计划/交货/入库)</th>
    <th>预计交货时间</th>
    <th>FBA-ShipmentId</th>
    <th>FnSku</th>
    <th>仓库</th>
    <th>预计运输时间</th>
    <th>预计到达时间</th>
    <th>运输单</th>
    <th>运输方式</th>
    <th>创建时间</th>
    <th>创建人</th>
  </tr>
#{list items:units, as:'unit'}
  <tr id="procureUnit_${unit.id}">

    <td>
      <label class="checkbox">
          #{set cooperItem: unit.cooperator?.cooperItem(unit.sku)/}
          #{if unit.fba && unit.fba.dto}
            <!-- 优先使用自身的 FBA 箱包装数据 -->
              #{set dto: unit.fba.dto/}
            <input type="checkbox" name="pids" value="${unit.id}" class="${tr_key}" id="checkbox_${unit.id}"
                   data-boxnum="${dto.boxNum}" data-num="${dto.num}" data-lastcartonnum="${dto.lastCartonNum}"
                   data-singleboxweight="${dto.singleBoxWeight}" data-length="${dto.length}"
                   data-width="${dto.width}" data-height="${dto.height}">
          #{/if}
          #{elseif cooperItem}
            <!-- 使用维护好的合作伙伴的数据 -->
            <input type="checkbox" name="pids" value="${unit.id}" class="${tr_key}" id="checkbox_${unit.id}"
                   data-boxnum="${cooperItem.boxNum(unit.qty())}" data-num="${cooperItem.boxSize}"
                   data-lastcartonnum="${cooperItem.lastCartonNum(unit.qty())}"
                   data-singleboxweight="${cooperItem.singleBoxWeight}" data-length="${cooperItem.length}"
                   data-width="${cooperItem.width}" data-height="${cooperItem.height}">
          #{/elseif}
          #{else}
            <input type="checkbox" name="pids" value="${unit.id}" class="${tr_key}" id="checkbox_${unit.id}"
                   data-boxnum="" data-num="" data-lastcartonnum="" data-singleboxweight="" data-length=""
                   data-width="" data-height="">
          #{/else}
      </label>
    </td>
    <td><a href="@{ProcureUnits.edit(unit.id, 'show')}">${unit.id}</a></td>
    <td style="background:${unit.stage.rgb()}">${unit.stage.label()}</td>
    <td>
        #{if unit.stage.name()=='PLAN'}
          <a href="@{ProcureUnits.edit(unit.id, 'edit')}" class="btn btn-mini btn-primary">修改</a>
          <a href="@{ProcureUnits.delete(unit.id)}" class="btn btn-mini btn-danger" name="deleteBtn">删除</a>
        #{/if}
        #{elseif unit.stage.name()=='DELIVERY'}
            #{power.ck "procures.dosplitunit"}
              <!-- 分拆采购单元 -->
              <a href="@{ProcureUnits.splitUnit(unit.id)}" class="btn btn-mini btn-warning" rel='tooltip'
                 title='因工厂延期交货而分拆'>分拆</a>
            #{/power.ck}
        #{/elseif}
        #{if unit.fba}
            #{power.ck 'fbas.update'}
              <div class="btn-toolbar" style="display:none;">
                <a href="@{FBAs.changeFBA(unit.id)}" class="btn btn-small btn-warning" data-disable-with='处理中...'
                   title="由于FBA过期或者需要更换">更换 ${unit.fba?.shipmentId}
                </a>
                <a href="@{FBAs.packingSlip(unit.fba.id)}" target="_blank" class="btn btn-small btn-success">箱內麦</a>
                <a href="javascript:void(0)" class="btn btn-small btn-success" name="boxLabelBtn" data-id="${unit.fba.id}">箱外麦</a>
              </div>
            #{/power.ck}
        #{/if}
        #{if unit.stage.name()!='PLAN'}
          <a href="@{ProcureUnits.edit(unit.id, 'show')}" class="btn btn-mini btn-info">查看</a>
        #{/if}
    </td>
    <td class="selling_id">
      <a href="@{Sellings.selling(unit.selling?.sellingId)}" target="_blank">${unit.selling?.sellingId}</a>
    </td>
    <td><a href="@{Products.show(unit.sku)}" target="_blank">${unit.product.sku}</a></td>
    <td title="${unit.product.abbreviation}">
        #{if unit.product.abbreviation.length() <= 15}
        ${unit.product.abbreviation}
        #{/if}
        #{else }
        ${unit.product.abbreviation.substring(0,15)}...
        #{/else}
    </td>
    <td>
        #{set qtys: unit.qtys()/}
      <span>${qtys._1 == null ? 0 : qtys._1}</span>/
      <!-- 1. 如果收货数不等于计划数，则收货数需要标红 -->
            <span style="${qtys._1 != null && qtys._2 != null && qtys._2 < qtys._1 ? 'color:red' : ''}">
            ${qtys._2 == null ? 0 : qtys._2}
            </span>/
      <!-- 2.如果入库数不等于收货数，则入库数需要标红 -->
            <span style="${qtys._2 != null && qtys._3 != null && qtys._3 < qtys._2 ? 'color:red' : ''}">
            ${qtys._3 == null ? 0 : qtys._3}
            </span>
    </td>
    <td>#{time_tooltip time:unit.attrs.planDeliveryDate/}</td>
    <td>${unit.fba?.shipmentId}</td>
    <td>
      <!-- FnSku 下载 Label -->
        #{if unit.selling?.fnSku}
          <a href="@{ProcureUnits.fnSkuLable(unit.sid, false)}" class="btn btn-success btn-block">
            <i class="icon-download-alt"></i> ${unit.selling.fnSku}
          </a>
        #{/if}
        #{elseif unit.selling != null}
          <a class="btn btn-warning btn-block" href="@{Sellings.selling()}/${unit.selling?.sellingId}">
            补全 FnSku
          </a>
        #{/elseif}
    </td>
    <td>${unit.whouse?.name()}</td>
    <td>#{time_tooltip time:unit.attrs.planShipDate /}</td>
    <td>#{time_tooltip time:unit.attrs.planArrivDate /}</td>
    <td></td>
    <td style="color:${unit.shipType.rgb()}">${unit.shipType?.label()}</td>
    <td>#{time_tooltip time:unit.createDate/}</td>
    <td>${unit.creator?.username}</td>
  </tr>
#{/list}
#{if p != null}
  <tr class="tb_footer">
    <td colspan="25">
        #{bootstrap_pager pi:p, url:'' /}
    </td>
  </tr>
#{/if}
</table>