#{script 'procureunits/_unit_list.coffee'/}
#{set tr_key: key ? key : 'unit'/}
<table class="table table-condensed table-bordered" id="unit_table">
  <tr>
  #{if checkbox}
    <th>
      <label class="checkbox">
        <input type="checkbox" id="${key ? tr_key + '_' : ''}checkbox_all" class="${tr_key} checkall">
      </label>
    </th>
  #{/if}
    <th>#</th>
    <th>Selling</th>
    <th>Sku</th>
    <th>FBA-ShipmentId</th>
    <th>采购单</th>
    <th>仓库</th>
    <th>供应商</th>
    <th>采购数量</th>

  #{if deliveryplan!=true}
    <th>单价</th>
    <th rel="popover" content="如果交货, 数量为交货数量, 如果没有交货,则为计划采购数量">
      <abbr title=" ">总价</abbr>
    </th>
    <th>剩余请款金额</th>
  #{/if}
    <th rel="popover" content="<img src='/img/helper/fnsku.png' />" width="auto">FnSku</th>
    <th>运输方式</th>
    <th>预计交货时间</th>
    <th>预计运输时间</th>
    <th>实际交货时间</th>
    <th>阶段</th>
    <th>抵达货代</th>
    <th>是否核对</th>
    <th>是否出库</th>
    <th>是否发货</th>
    <th>质检信息</th>
    <th>创建时间</th>
  </tr>
#{list items:units, as:'unit'}
  <tr id="procureUnit_${unit.id}">
      #{if checkbox}
        <td>
          <label class="checkbox">
              #{set cooperItem: unit.cooperator?.cooperItem(unit.sku)/}
              #{if unit.fba && unit.fba.dto}
                <!-- 优先使用自身的 FBA 箱包装数据 -->
                  #{set dto: unit.fba.dto/}
                <input type="checkbox" name="pids" value="${unit.id}" class="${tr_key}" id="checkbox_${unit.id}"
                       data-boxnum="${dto.boxNum}" data-num="${dto.num}" data-lastcartonnum="${dto.lastCartonNum}"
                       data-singleboxweight="${dto.singleBoxWeight}" data-length="${dto.length}"
                       data-width="${dto.width}" data-height="${dto.height}">
              #{/if}
              #{elseif cooperItem}
                <!-- 使用维护好的合作伙伴的数据 -->
                <input type="checkbox" name="pids" value="${unit.id}" class="${tr_key}" id="checkbox_${unit.id}"
                       data-boxnum="${cooperItem.boxNum(unit.qty())}" data-num="${cooperItem.boxSize}"
                       data-lastcartonnum="${cooperItem.lastCartonNum(unit.qty())}"
                       data-singleboxweight="${cooperItem.singleBoxWeight}" data-length="${cooperItem.length}"
                       data-width="${cooperItem.width}" data-height="${cooperItem.height}">
              #{/elseif}
              #{else}
                <input type="checkbox" name="pids" value="${unit.id}" class="${tr_key}" id="checkbox_${unit.id}"
                       data-boxnum="" data-num="" data-lastcartonnum=""
                       data-singleboxweight="" data-length=""
                       data-width="" data-height="">
              #{/else}
          </label>
        </td>
      #{/if}
    <td data-toggle="toggle" data-target="#${tr_key}_${unit.id}" style="cursor:pointer;">
      <i class="icon-reorder"></i> ${unit.id}</td>
    <td class="selling_id">
      <a href="@{Sellings.selling(unit.selling?.sellingId)}" target="_blank">${unit.selling?.sellingId}</a>
    </td>
    <td>
      <a href="@{Products.show(unit.sku)}" target="_blank" rel="popover" content="${cooperItem?.memo}">${unit.sku}</a>
    </td>
    <td>
        #{if unit.fba}
            #{cache unit.fba.feedsPageCacheKey(), for:'3h'}
            ${unit.fba.shipmentId}
                #{set feeds: unit.fba.feeds()/} <!-- TODO 跟踪是否任旧会导致耗尽 request pool-->
                #{if feeds.size() > 0}
                    #{render '/app/views/gt_templates/feeds.html', feeds: feeds, key: unit.fba.shipmentId, fid: unit.fba.id/}
                    #{set lastFeed: feeds.get(0)/}
                    #{if lastFeed.isFailed()}
                      <i style="color:#dc143c;" class="icon-warning-sign" name="showFeedsPage"
                         data-feeds-page="${unit.fba.shipmentId}" rel="tooltip" title="FBA 装箱信息提交失败"></i>
                    #{/if}
                    #{elseif lastFeed.isSussess()}
                      <i style="color:green;" class="icon-ok-sign" name="showFeedsPage"
                         data-feeds-page="${unit.fba.shipmentId}" rel="tooltip" title="FBA 装箱信息提交成功">
                      </i>
                    #{/elseif}
                    #{else }
                      <i class="icon-search" name="showFeedsPage"
                         data-feeds-page="${unit.fba.shipmentId}" rel="tooltip" title="FBA 装箱信息正在提交中">
                      </i>
                    #{/else}
                #{/if}
            #{/cache}
        #{/if}
    </td>
    <td>
        #{if unit.deliveryment}
          <a href="@{Deliveryments.show(unit.deliveryment.id)}">${unit.deliveryment.id}</a>
        #{/if}
    </td>
    <td>${unit.whouse?.name()}</td>
    <td>${unit.cooperator?.name}</td>
    <td>${unit.attrs.planQty}</td>

      #{if deliveryplan!=true}
        <td>${unit.attrs.currency.symbol()} ${new java.math.BigDecimal(unit.attrs.price).setScale(2,4).floatValue().format('#,###.##')}</td>
        <td>${unit.attrs.currency.symbol()} ${new java.math.BigDecimal(unit.qty() * unit.attrs.price).setScale(2,4).floatValue().format('#,###.##')}</td>
        <td>${unit.attrs.currency.symbol()} ${new java.math.BigDecimal(unit.leftAmount()).setScale(2,4).floatValue().format('#,###.##')}</td>
      #{/if}


    <td>
      <!-- FnSku 下载 Label -->
        #{if unit.selling?.fnSku}
          <a href="@{Sellings.sellingLabel(unit.sid)}" class="btn btn-success btn-block">
            <i class="icon-download-alt"></i> ${unit.selling.fnSku}
          </a>
        #{/if}
        #{elseif unit.selling != null}
          <a class="btn btn-warning btn-block" href="@{Sellings.selling()}/${unit.selling?.sellingId}">
            补全 FnSku
          </a>
        #{/elseif}
    </td>
    <td style="color:${unit.shipType.rgb()}">${unit.shipType?.label()}</td>
    <td>#{time_tooltip time:unit.attrs.planDeliveryDate/}</td>
    <td>#{time_tooltip time:unit.attrs.planShipDate /}</td>
    <td>#{time_tooltip time:unit.attrs.deliveryDate/}</td>
    <td style="background:${unit.stage.rgb()}">${unit.stage.label()}</td>
    <td id="isplaced_${unit.id}">#{yesOrNo f:unit.isPlaced/}</td>
    <td>#{yesOrNo f:unit.isConfirm/}</td>
    <td>${unit.isOut?.label()}</td>
    <td>${unit.isship()}</td>
    <td>
        #{set taskLink: unit.fetchCheckTaskLink()/} <!-- TODO 跟踪是否任旧会导致耗尽 request pool-->
        #{if taskLink}
          <a href="${taskLink}" target="_blank">查看</a>
        #{/if}
    </td>
    <td>#{time_tooltip time:unit.createDate/}</td>
  </tr>

  <tr id="${tr_key}_${unit.id}" style="display:none;">
    <td colspan="${checkbox ? '24' : '22'}">
      <div class="row-fluid" id="actions_${unit.id}">

        <div class="span3">
          <dl>
            <dt>Comment</dt>
            <dd>${unit.comment}</dd>
          </dl>

        </div>
        <div class="span3">
          <dl>
            <dt>关联运输单</dt>
            <dd>
              <ul>
                  #{list items:unit.relateShipment(), as:'sp'}
                    <li>
                      <a href="@{Shipments.show(sp.id)}">${sp}</a>
                      预计 #{time_tooltip time: sp.dates.planBeginDate /} 开船
                    </li>
                  #{/list}
              </ul>
            </dd>
          </dl>
          <dl>
            <dt>关联 FBA</dt>
            <dd>
                #{if unit.fba}
                  <a href="${unit.fba.fbaLink()}">
                    <i class="icon-external-link"></i>
                  ${unit.fba.shipmentId}
                  </a>
                #{/if}
                #{else }
                  <span class="text-warning">还没有 FBA</span>
                #{/else}
            </dd>
          </dl>
        </div>

        <div class="span3">
          <table class="table table-condensed table-bordered">
            <tr>
              <td>实际交货量</td>
              <td>实际交货日期</td>
            </tr>
            <tr>
              <td>${unit.attrs.qty}</td>
              <td>${unit.attrs.deliveryDate.los()}</td>
            </tr>
          </table>
        </div>

        <div class="span3">
          <div class="btn-toolbar">
            <!-- 普通修改 -->
              #{if unit.selling}
                <a href="@{ProcureUnits.edit(unit.id)}" target="_blank" class="btn btn-small btn-primary">修改</a>
              #{/if}
              #{else }
                <a href="@{ProcureUnits.editManual(unit.id)}" target="_blank" class="btn btn-small btn-primary">修改</a>
              #{/else}
              #{if unit.stage in [models.procure.ProcureUnit.STAGE.PLAN, models.procure.ProcureUnit.STAGE.DELIVERY]}
                <a href="@{ProcureUnits.destroy(unit.id)}" data-method='DELETE' data-confirm="确认删除?" class="btn btn-small btn-danger">
                  删除
                </a>
              #{/if}
          </div>

            #{if delivery}
              <div class="btn-toolbar">
                  #{power.ck "procures.delivery"}
                      #{if unit.selling}
                        <!-- 交货页面（没有Selling不允许） -->
                        <a href="@{ProcureUnits.deliveryUnit(unit.id)}" class="btn btn-small btn-warning">交货</a>
                      #{/if}
                  #{/power.ck}
                  #{power.ck "procures.dosplitunit"}
                    <!-- 分拆采购单元 -->
                    <a href="@{ProcureUnits.splitUnit(unit.id)}" class="btn btn-small btn-danger"
                       rel='tooltip' title='因工厂延期交货而分拆'>
                      分拆
                    </a>
                  #{/power.ck}
                <!-- 确认到货代处 -->
                  #{if unit.selling}
                      #{ifnot unit.isPlaced}
                        <a data-remote='true' data-method='PUT' class="btn btn-small btn-info" id="isplaced_${unit.id}_btn"
                           href="@{ProcureUnits.markPlace(unit.id)}" data-disable-with='更新中'>抵达货代</a>
                      #{/ifnot}
                  #{/if}
                <a data-remote='true' data-method='PUT' class="btn btn-small btn-warning" id="isConfirm_${unit.id}_btn"
                   href="@{ProcureUnits.confirmUnit(unit.id)}" data-disable-with='更新中'>已核单</a>
              </div>
                #{if unit.fba}
                    #{power.ck 'fbas.update'}
                      <div class="btn-toolbar">
                        <a href="javascript:void(0)" class="btn btn-small btn-warning" id="replaceUnitFBA"
                           data-unit-id="${unit.id}" title="由于FBA过期或者需要更换">更换 ${unit.fba?.shipmentId}
                        </a>
                      </div>
                    #{/power.ck}
                #{/if}
              <div class="btn-toolbar">
                  #{if unit.fba}
                    <a href="@{FBAs.packingSlip(unit.fba.id)}" target="_blank" class="btn btn-small btn-success">箱內麦</a>
                    <a href="javascript:void(0)" class="btn btn-small btn-success" name="boxLabelBtn" data-id="${unit.fba.id}">箱外麦</a>
                  #{/if}
              </div>
            #{/if}
        </div>
      </div>
        #{ifnot norecord}
            #{cache unit.recordsPageCacheKey(), for:'3h'}
              <div style="max-height:160px;overflow:auto;margin-bottom:20px;">
                  #{records_ul  records: unit.records()/} <!-- TODO 跟踪是否任旧会导致耗尽 request pool-->
              </div>
            #{/cache}
        #{/ifnot}
    </td>
  </tr>
#{/list}
#{if p != null}
  <tr class="tb_footer">
    <td colspan="25">
        #{bootstrap_pager pi:p, url:'' /}
    </td>
  </tr>
#{/if}
</table>