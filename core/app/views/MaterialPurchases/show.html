#{extends 'main_full.html'/}
#{set title:"物料采购单 #" + dmt.id /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'timeline/timeline_js/timeline-api.js'/}
    #{script 'MaterialPurchases/show.es6'/} 
    #{script 'deliveryments/show.coffee'/}
#{/set}

#{errorMsgs /}
#{flash_alert /}

#{set isPending: Arrays.asList('PENDING','APPROVE','REJECT').contains(dmt.state.name()) /}
#{info_row title:'物料采购单信息'/}

<div class="row-fluid">
#{if dmt.state.name().equals("PENDING_REVIEW")}
  <ul class="nav nav-tabs">
    <li class="active" id="below_tab">
      <a href="#currentPage" data-toggle='tab'>待审采购单</a>
    </li>
    <li>
      <a href="#relateDelivery" data-toggle='tab'>相关采购单</a>
    </li>
  </ul>
#{/if}
  <div class="tab-content">
    <div class="tab-pane fade active in" id='currentPage'>
      <form action="@{MaterialPurchases.update()}" method="post" name="updateDeliverymentForm" id="updateDeliverymentForm">
        <table class="table table-condensed table-bordered">
          <tr>
            <th width="120px;">物料采购单ID</th>
            <td>
              <span id="deliverymentId">${dmt.id}</span>
              <input type="hidden" name="dmt.id" value="${dmt.id}">
            </td>

            <th>State</th>
            <td style="color:${dmt.state.rgb()}" width="400px;">
            ${dmt.state.label()}
            #{if dmt.state.name().equals("PENDING_REVIEW")}
              (${applyMsg?.split(",")[0]})
            #{/if}
            </td>
          </tr>

          <tr>
            <th>Name</th>
            <td>
              <input type="text" class="span10" name="dmt.name" value="${dmt.name}">
            </td>
            <th>供应商</th>
            <td>${dmt.cooperator?.name}</td>
          </tr>
          <tr>
            <th>下单时间</th>
            <td>
              <input type="date" name="dmt.orderTime" value="${dmt.orderTime?.date()}">
            </td>
            <th>交货时间</th>
            <td>
              <input type="date" name="dmt.deliveryTime" value="${dmt.deliveryTime?.date()}">
            </td>
          </tr>
          <tr>
            <th>User</th>
            <td>${dmt.handler.username}</td>
            <th>项目名称</th>
            <td>
              <select name="dmt.projectName" class="inline">
                <option value="">项目名称</option>
              #{list items:models.User.COR, as:'c'}
                  #{if java.util.Arrays.asList(brandName,models.User.COR.MengTop.name()).contains(c.name())}
                    <option ${c.name() == dmt.units[0].projectName ? 'selected' : ''} value="${c.name()}">${c.label()
                    }</option>
                  #{/if}
              #{/list}
              </select>
            </td>
          </tr>
          <tr>
            <th><h4>Memo:</h4></th>
            <td colspan="3">
              <textarea rows="5" name="dmt.memo" class="span12">${dmt.memo}</textarea>
            </td>
          </tr>
        #{power.ck "products.edit"}
          <tr>
            <td colspan="4">
              <button class="btn btn-primary">更新</button>
            </td>
          </tr>
        #{/power.ck}
        </table>
      </form>
    </div>

  </div>
</div>


<div class="row-fluid">
  <div class="span12">
  #{if isPending}
    <form action="@{MaterialPurchases.confirm()}" method="post" style="display:inline-block;" id="confirmForm">
      <div class="input-prepend input-append" style="float:left;">
        <span class="add-on" rel="popover" content="确认物料采购单, 物料采购单进行确认以后, 才可以在运输单中进行挑选, 并且不再允许添加新的采购计划"
              placement="right"><i class="icon-question-sign"></i></span>
        <input type="hidden" name="id" value="${dmt.id}">
          #{power.ck "products.edit"}
            <input type="button" class="btn btn-primary" id="confirmBtn" value="确认">
          #{/power.ck}
      </div>
    </form>
  #{/if}
  #{power.ck 'deliveryments.cancel'}
    <form action="@{MaterialPurchases.cancel()}" method="post" style="display:inline-block;" id="cancelForm">
      <input type="hidden" name="id" value="${dmt.id}">
      <div class="input-append" style="float:left;margin-left:10px;">
        <input type="text" name="msg" value="${msg}" placeHolder="简要填写关闭的原因">
        <button class="btn btn-danger" id="cancelBtn">取消采购单</button>
      </div>
    </form>
  #{/power.ck}

  </div>
</div>

<div class="row-fluid">
  <div class="span12 alert">
    <h4>供应商反馈 <i class="icon-reorder"></i></h4>
  </div>
</div>




#{success_row title:"已经添加进入[物料采购单]的[物料计划]"/}
<form action="#" id="bulkpost" method="POST">
  <input type="hidden" name="expressid" id="expressid" value="${expressid}">
  <div class="row-fluid">
    <div class="span12" id="unit_list">
    #{render 'MaterialPurchases/_unit_list.html', units:dmt.units, checkbox:true, key:'delivery', delivery:true/}
    </div>
  </div>
  <div class="row-fluid">
    <div class="btn-toolbar">
    #{power.ck "products.edit"}
      <a href="javascript:void(0);" data-url='@{MaterialPurchases.delunits(dmt.id)}' data-method="DELETE"
         id="delunit_form_submit" rel="popover" content="将 DELIVERY 状态的采购计划从物料采购单中移除出去" placement="right" class="btn
         btn-warning">
        解除
      </a>
    #{/power.ck}
      <input id='form_method' type="hidden" name="x-http-method-override" value="POST">
    </div>
  </div>
</form>


<div class="row-fluid">
  <div class="span12 alert">
    <h4 data-toggle="toggle" data-target="#excel">生成物料采购单信息 <i class="icon-reorder"></i></h4>
  </div>
</div>


#{if  Arrays.asList('PENDING','CONFIRM').contains(dmt.state.name())}
    #{info_row title:'可添加进入[采购单]的[采购单元]'/}
    #{form @Deliveryments.addunits(dmt.id), method: 'POST'}
    <div class="row-fluid">
      <div class="span12">
        <input type="hidden" name="dmt.id" value="${dmt.id}">
          #{render 'MaterialPurchases/_unit_list.html', units:plan_units, checkbox:true, key:'plan'/}
      </div>
    </div>
    <div class="row-fluid">
      <div class="span12">
        <div class="pull-left input-prepend input-append">
          <span class="add-on" rel="popover" content="将 PLAN 状态的采购计划添加到采购单中" placement="right"><i class="icon-question-sign"></i></span>
            #{power.ck "products.edit"}
              <button id="plan_form_submit" class="btn btn-primary">添加</button>
            #{/power.ck}
        </div>
      </div>
    </div>
    #{/form}
#{/if}

#{records records:records/}

<div class="row-fluid">
  <div class="span12">
    <h4 class="alert alert-success">附件 <i class="icon-sort-down"></i></h4>
  </div>
</div>
<div class="row-fluid">
  <div style="min-height:300px;" class="span12 well" id="dropbox">
    <ul class="thumbnails uploaded"></ul>
  #{power.ck "products.edit"}
    <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
  #{/power.ck}
  </div>
</div>


<!--  修改物料计划 弹出div begin   -->
<div id="bom_modal" class="modal hide fade">
  <div class="modal-header">
    <h4>物料计划修改</h4>
  </div>
  <div class="modal-body" style="height:300px;">
    <form action="@{MaterialUnits.updateMaterialUnit()}" method="post" id="updateUnit_form">
      <input type="hidden" name="unit.id" id="unit_id">
      <table class="table table-condensed table-bordered">
        <tr>
          <th width="30%">采购数量</th>
          <td>
            <input type="text" placeHolder="具体数量" id="unit_planQty" name="unit.planQty">
          </td>
        </tr>
        <tr>
          <th>价格</th>
          <td>
            <input type="text" id="unit_planPrice" name="unit.planPrice">
            <select style="width:100px;" id="unit_planCurrency" name="unit.planCurrency">
            #{list items:helper.Currency, as:'c'}
              <option value="${c.name()}">${c.name()}</option>
            #{/list}
            </select>
          </td>
        </tr>
        <th>预计交货时间</th>
        <td><input type="date" name="unit.planDeliveryDate" id="unit_planDeliveryDate"></td>
      </table>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
    <button class="btn btn-primary" id="submitUpdateBtn">提交</button>
  </div>
</div>
<!--  修改物料计划 弹出div end   -->