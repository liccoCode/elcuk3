#{extends 'main_full.html'/}
#{set title:"${payment.paymentNumber?:''}" /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'payments/show.coffee'/}
#{/set}

#{flash_alert /}
#{form @Payments.paymentUnitApproval(payment.id), method:'POST'}
<div class="row-fluid" xmlns="http://www.w3.org/1999/html">
  <div class="btn-toolbar">
    <input type="submit" class="btn btn-info" value="批准"/>
  </div>
  <table class="table table-bordered table-condensed">
    <tr>
      <th></th>
      <th>采购计划</th>
      <th>交货日期</th>
      <th>SKU</th>
      <th>单价</th>
      <th>数量</th>
      <th>付款类型</th>
      <th>总额修正价</th>
      <th>付款金额</th>
      <th>请款人</th>
      <th>状态</th>
      <th>#</th>
    </tr>
      #{list items:payment.units(), as:'paymentUnit'}
        <tr id="paymentUnit_${paymentUnit.id}">
            #{set punit: paymentUnit.procureUnit/}
            #{set records:paymentUnit.fixValueRecords()/}
            #{set denyRecords: paymentUnit.denyRecords()/}
          <td>
            <label>
              <input type="checkbox" name="paymentUnitIds" value="${paymentUnit.id}">
            </label>
          </td>
          <td ${((records.size() + denyRecords.size()) > 0) ? 'data-toggle=\'toggle\'' : ''} data-target='#unit_${paymentUnit.id}'>
              #{if (records.size() + denyRecords.size()) > 0}
                <i class="icon-reorder"></i>
              #{/if}
            <a href="@{Deliveryments.show(paymentUnit.deliveryment.id)}#${punit.id}">
            ${paymentUnit.deliveryment.id} #${punit.id}
            </a>
          </td>
          <td>${punit.attrs.deliveryDate}</td>
          <td>${punit.sku}</td>
          <td>${payment.currency.symbol()} ${punit.attrs.price}</td>
          <td>${punit.qty()}</td>
          <td>${paymentUnit.feeType.nickName}</td>
          <td>${payment.currency.symbol()} ${paymentUnit.fixValue}</td>
          <td>${payment.currency.symbol()} ${paymentUnit.amount()}</td>
          <td>${paymentUnit.payee.username}</td>
          <td>
            <span class="label ${paymentUnit.stateLabel()}">${paymentUnit.state.label()}</span>
              #{if paymentUnit.state in [models.finance.PaymentUnit.S.APPLY, models.finance.PaymentUnit.S.APPROVAL]}
                <button url='@{PaymentUnits.deny(payment.id, paymentUnit.id)}' class="btn btn-danger btn-mini paymentUnitDeny">
                  驳回
                </button>
              #{/if}
          </td>
          <td>
            <a href="@{Applys.procure(payment.pApply.id)}#${paymentUnit.id}" target="_blank">
            ${payment.pApply.serialNumber} #${paymentUnit.id}
            </a>
          </td>
        </tr>
        <tr id="unit_${paymentUnit.id}" style="display:none">
          <td colspan="4"></td>
          <td colspan="3">
              #{if records.size() > 0}
                  #{records_ul records: records/}
              #{/if}
          </td>
          <td colspan="5">
              #{if denyRecords.size() > 0}
                  #{records_ul records: denyRecords/}
              #{/if}
          </td>
        </tr>
      #{/list}
  </table>
</div>
#{/form}

<div class="row-fluid">
  <div class="span6" id="boc_rate" style="max-height:250px;overflow-y:auto">
  </div>
  <div class="span6">
    <div class="btn-toolbar">
      <button url='@{Payments.rates()}' class="btn" id="boc_rate_btn">
        <i class="icon-refresh"></i> 更新
      </button>
    </div>
    <div class="row-fluid">
      <div class="span4">
        <dl class="dl-horizontal" style="margin-top:0">
          <dt>批准后总金额</dt>
          <dd><span id="currency">${payment.currency.symbol()}</span>
            <span id="costs">${payment.approvalAmount()}</span></dd>
          <dt>需要支付的美金</dt>
          <dd>$ <span id="usd_costs"></span></dd>
          <dt>美元 -> 人民币</dt>
          <dd>$ 1 -> ¥ <span id="usd_rates"></span></dd>
          <dt>汇率时间</dt>
          <dd><span id="usd_datetime"></span></dd>
        </dl>
      </div>
      <div class="span8">
      #{if payment.state == models.finance.Payment.S.PAID}
        <dl class="dl-horizontal" style="margin-top:0">
          <dt>支付状态</dt>
          <dd style="color:${payment.stateColor()}">${payment.state.label()}</dd>
          <dt>支付时间</dt>
          <dd>${payment.paymentDate}</dd>
          <dt>汇率时间</dt>
          <dd>${payment.ratePublishDate}</dd>
          <dt>支付人</dt>
          <dd>${payment.payer?.username}</dd>
          <dt>实际支付金额</dt>
          <dd>${payment.currency.symbol()} ${payment.actualPaid}</dd>
        </dl>
      #{/if}
      #{else }
          #{form @Payments.payForIt(payment.id), method:'POST', class:'form-horizontal', id:'pay_form'}
            <div class="control-group">
              <label class="control-label">供应商</label>

              <div class="controls">
                <input type="text" placeholder="供应商" value="${payment.cooperator.fullName}" readonly="">
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">账号</label>

              <div class="controls">
                  #{select 'paymentTargetId', items: payment.cooperator.paymentMethods, valueProperty:id}#{/select}
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">币种</label>

              <div class="controls">
                  #{pickCurrency name:'currency', c:payment.currency /}
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">金额</label>

              <div class="controls">
                <input type="text" placeholder="最终支付金额" name="actualPaid" id="actualPaid">
              </div>
            </div>
            <div class="control-group">
              <div class="controls">
                <input type="submit" value="付款" class="btn btn-primary">
              </div>
            </div>
          #{/form}
      #{/else}
      </div>
    </div>
  </div>
</div>

<div class="row-fluid" style="margin-top:20px">
  <div style="min-height:300px;background:#eee;" id="dropbox" paymentId='${payment.id}'>
    <ul class="thumbnails uploaded"></ul>
    <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
  </div>
</div>

<div id="deny_modal" class="modal hide fade">
  <form action="#" method="post" id="deny_form">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3><span class="text-info" id="deny_title"></span></h3>
    </div>
    <div class="modal-body">
      <label for="deny_reason">驳回原因</label>
      <textarea id="deny_reason" rows="3" class="span6" name="reason"></textarea>
    </div>
    <div class="modal-footer">
      <input type="submit" class="btn btn-danger" value="驳回">
    </div>
  </form>
</div>
