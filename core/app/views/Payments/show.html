#{extends 'main_full.html'/}
#{set title:"${payment.paymentNumber?:''}" /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'payments/show.coffee'/}
#{/set}

#{flash_alert /}

#{if payment.pApply}
    #{render './_procreApply.html', payment: payment/}
#{/if}

#{if payment.tApply}
    #{render './_transportApply.html', payment: payment/}
#{/if}

<div class="row-fluid">

  <div class="span6" style="max-height:300px">
    <div id="payment_records" style="margin-bottom:15px;height:130px;overflow-y:auto">
    #{records_ul records: payment.records(), nobr:true /}
    </div>
    <div id="boc_rate" style="max-height:150px;overflow-y:auto"></div>
  </div>
  <div class="span6">
    <div class="btn-toolbar">
      <button url='@{Payments.rates()}' class="btn" id="boc_rate_btn">
        <i class="icon-refresh"></i> 更新
      </button>
    #{power.ck 'payments.cancel'}
        #{if payment.cancelable()}
          <button url="@{Payments.cancel(payment.id)}" id="payment_cancel" class="btn btn-danger">
            取消付款单
          </button>
        #{/if}
    #{/power.ck}
    </div>
    <div class="row-fluid">
      <div class="span5">
        <dl class="dl-horizontal" style="margin-top:0">
          <dt>批准后总金额</dt>
          <dd><span id="currency_label">${payment.currency.symbol()}</span>
            <span id="costs">${payment.approvalAmount()}</span></dd>
          <dt>需要支付的美金</dt>
          <dd>$ <span id="usd_costs"></span></dd>
          <dt>美元 -> 人民币</dt>
          <dd>$ 1 -> ¥ <span id="usd_rates"></span></dd>
          <dt>汇率时间</dt>
          <dd><span id="usd_datetime"></span></dd>
        </dl>
        <dl class="dl-horizontal">
          <dt>编号</dt>
          <dd><a href="@{Payments.show(payment.id)}">${payment.paymentNumber}</a></dd>
          <dt>系统 ID</dt>
          <dd>${payment.id}</dd>
          <dt>请款单</dt>
        #{if payment.pApply}
          <dd><a href="@{Applys.procure(payment.pApply.id)}">${payment.pApply.serialNumber}</a></dd>
        #{/if}
        #{elseif payment.tApply}
          <dd><a href="@{Applys.procure(payment.tApply.id)}">${payment.tApply.serialNumber}</a></dd>
        #{/elseif}
          <dt>最后更新时间</dt>
          <dd>#{time_tooltip time: payment.updateAt, datetime:true/}</dd>
          <dt>创建时间</dt>
          <dd>#{time_tooltip time: payment.createdAt, datetime:true/}</dd>
        </dl>
      </div>
      <div class="span7">
      #{if payment.state == models.finance.Payment.S.PAID}
        <dl class="dl-horizontal" style="margin-top:0">
          <dt>支付状态</dt>
          <dd style="color:${payment.stateColor()}">${payment.state.label()}</dd>
          <dt>支付时间</dt>
          <dd>${payment.paymentDate}</dd>
          <dt>汇率</dt>
          <dd>${payment.rate}</dd>
          <dt>汇率时间</dt>
          <dd>${payment.ratePublishDate}</dd>
          <dt>支付人</dt>
          <dd>${payment.payer?.username}</dd>
          <dt>(计算)应该支付</dt>
          <dd>${payment.actualCurrency.symbol()} ${payment.shouldPaid}</dd>
          <dt>&nbsp;</dt>
          <dd>&nbsp;</dd>
          <dt>实际支付金额</dt>
          <dd>${payment.actualCurrency.symbol()} ${payment.actualPaid}</dd>
          <dt>对方账号</dt>
          <dd>${payment.target.accountNumber}</dd>
          <dt>对方账户</dt>
          <dd>${payment.target.accountUser}</dd>
        </dl>
      #{/if}
      #{else }
          #{power.ck 'payments.payforit'}
              #{form @Payments.payForIt(payment.id), method:'POST', class:'form-horizontal', id:'pay_form'}
                <div class="control-group">
                  <label class="control-label">供应商</label>

                  <div class="controls">
                    <input type="text" placeholder="供应商" value="${payment.cooperator.fullName}" readonly="">
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">账号</label>

                  <div class="controls">
                      #{select 'paymentTargetId', items: payment.cooperator.paymentMethods, valueProperty:id}#{/select}
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">币种</label>

                  <div class="controls">
                    <select id='currency' name="currency">
                        #{list items:[helper.Currency.CNY, helper.Currency.USD], as:'cr'}
                          <option ${cr == payment.currency ? 'selected' : ''} value="${cr}">${cr}</option>
                        #{/list}
                    </select>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">金额</label>
                  <input type="hidden" id="ratio" name="ratio" value="-1">
                  <input type="hidden" id="ratio_publish_date" name="ratio_publish_date">

                  <div class="controls">
                    <input type="text" placeholder="最终支付金额" name="actualPaid" id="actualPaid">
                  </div>
                </div>
                <div class="control-group">
                  <div class="controls">
                    <input type="submit" value="付款" class="btn btn-primary"
                           data-confirm='请再次确认信息后付款'>
                  </div>
                </div>
              #{/form}
            <form action="#" class="form-horizontal" onsubmit="return false;">
              <div class="control-group">
                <label class="control-label">应付金额</label>

                <div class="controls">
                  <div class="input-append">
                    <input type="text" class="input-small"
                           url='@{Payments.shouldPaidUpdate (payment.id)}'
                           placeholder="手动输入确认" name="actualPaid" id="shouldPaid">
                    <span class="add-on" id="shouldPaidChanges"><i class="icon-question-sign"></i></span>
                  </div>
                </div>
              </div>
            </form>
          #{/power.ck}
      #{/else}
      </div>
    </div>
  </div>
</div>

#{power.ck 'payments.uploads'}
<div class="row-fluid" style="margin-top:20px">
  <div style="min-height:300px;background:#eee;" id="dropbox" paymentId='${payment.id}'>
    <ul class="thumbnails uploaded"></ul>
    <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
  </div>
</div>
#{/power.ck}

<div id="reason_model" class="modal hide fade">
  <form action="#" method="POST" id="model_form">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3><span class="text-info" id="model_title"></span></h3>
    </div>
    <div class="modal-body">
      <div class="row-fluid">
        <label for="model_reason">原因</label>
        <textarea id="model_reason" rows="3" class="span12" name="reason"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <input type="submit" class="btn btn-danger" value="驳回">
    </div>
  </form>
</div>
