#{extends 'main_full.html' /}
#{set title:"采购单[${dmt.id}]请款信息"  /}
#{set 'moreStyles'}
    #{stylesheet 'payments.css'/}
#{/set}
#{set 'moreScripts'}
    #{script 'payments.coffee'/}
#{/set}

#{flash_alert /}

<div class="row-fluid btn-toolbar">
    <a href="/deliveryment/${dmt.id}" class="btn btn-success">回到采购单</a>
</div>

#{warning_row title:'采购单支付信息' /}
<div class="btn-toolbar">
    <button data-target="#add_form" data-toggle="toggle" class="btn btn-success">向采购单添加请款</button>
</div>

<div class="row-fluid" id="add_form">
    <form>

        <label>金额</label>
        <input type="text" name="pu.amount" value="0">
        <label>币种</label>
    #{pickCurrency /}
        <label>采购费用类型</label>
        <select name="pu.feeType">
        #{list items:procureFeeTypes, as:'ft'}
            <option value="${ft.name}">${ft.nickName}</option>
        #{/list}
        </select>
        <br>
        <button class="btn btn-primary">申请</button>
    </form>
</div>
<div class="row-fluid">
    <table class="table table-bordered table-condensed">
    #{if dmt.fees().size() <= 0}
        <tr>
            <td>暂时全部是采购单元的请款</td>
        </tr>
    #{/if}
    #{else }
        <tr>
            <th>#</th>
            <th>总请款金额</th>
            <th>修正值</th>
            <th>费用类型</th>
            <th>请款人</th>
            <th>请款时间</th>
            <th>状态</th>
        </tr>
        #{list items:dmt.fees(), as:'fee'}
            <tr id="payunit_${fee.id}">
                <td>${fee.id}</td>
                <td class="amount">${fee.currency.symbol()} ${fee.amount}</td>
                <td class="fix_value">${fee.currency.symbol()} ${fee.fixValue}</td>
                <td>${fee.feeType?.nickName}</td>
                <td>${fee.payee.username}</td>
                <td>${fee.createdAt.los()}</td>
                <td>${fee.state}</td>
            </tr>
        #{/list}
    *{<tr>}*
    *{<th>汇总:</th>}*
    *{<td id="fee_${unit.id}_amount"></td>}*
    *{<td id="fee_${unit.id}_fix_value"></td>}*
    *{<td colspan="5">&nbsp;</td>}*
    *{</tr>}*
    #{/else}
    </table>
</div>

#{info_row title:'采购单元支付信息' /}
<div class="row-fluid">
    <table class="table table-bordered table-condensed" id="procure_units_fees">
        <tr>
            <th>#</th>
            <th>SKU</th>
            <th>供应商</th>
            <th>采购数量</th>
            <th>实际交货数量</th>
            <th>单价</th>
            <th class="ten">进度</th>
            <th>实际交货时间</th>
            <th>阶段</th>
            <th class="five">抵达货代</th>
            <th class="ten">请款?</th>
        </tr>
    #{list items:dmt.units, as:'unit'}
        <tr>
            <td>${unit.id}</td>
            <td>${unit.sku}</td>
            <td>${unit.cooperator.name}</td>
            <td>${unit.attrs.planQty}</td>
            <td data-toggle="toggle" data-target="#unit_${unit.id}">
                <i class="icon-reorder"></i>
                <i class="badge ${unit.fees().size() > 0 ? 'badge-warning' : ''}">
                ${unit.fees().size()}
                </i>
            ${unit.attrs.qty}
            </td>
            <td>${unit.attrs.price.formatCurrency(unit.attrs.currency.name())}</td>
            <td>${unit.totalAmount()} / ${unit.totalBalance()}
                (${(unit.totalAmount() / unit.totalBalance()).format("#.#%")})
            </td>
            <td>${unit.attrs.deliveryDate}</td>
            <td style="background:${'#' + unit.stage.rgb()}">${unit.stage}</td>
            <td>#{yesOrNo f:unit.isPlaced/}</td>
            <td>
                <form class="inner_form" method="post" action="/deliveryment/${dmt.id}/payments">
                    <label class="inline checkbox">
                        <input type="checkbox" name="prepay" value="true"> 预付款
                    </label>
                    <input type="hidden" name="procureUnitId" value="${unit.id}">
                    <button class="btn btn-info btn-small">
                        填写请款
                    </button>
                </form>
            </td>
        </tr>
        <tr id="unit_${unit.id}" style="display:none;">
            <td colspan="11" class="toggle_table_td">
                #{if unit.fees().size() <= 0}
                    <div style="padding:10px">没有支付信息</div>
                #{/if}
                #{else }
                    <table class="table table-bordered table-condensed">
                        <tr>
                            <th>#</th>
                            <th>总请款金额</th>
                            <th>修正值</th>
                            <th>费用类型</th>
                            <th>请款人</th>
                            <th>请款时间</th>
                            <th>状态</th>
                            <th class="ten"></th>
                        </tr>
                        #{list items:unit.fees(), as:'fee'}
                            <tr id="payunit_${fee.id}">
                                <td>${fee.id}</td>
                                <td class="amount">${fee.currency.symbol()} ${fee.amount}</td>
                                <td class="fix_value">${fee.currency.symbol()} ${fee.fixValue}</td>
                                <td>${fee.feeType?.nickName}</td>
                                <td>${fee.payee.username}</td>
                                <td>${fee.createdAt.los()}</td>
                                <td>${fee.state}</td>
                                <td>
                                    <button uid="${unit.id}" class="btn btn-small btn-danger remove">
                                        <i class="icon-remove"></i>
                                    </button>
                                </td>
                            </tr>
                        #{/list}
                        <tr>
                            <th>汇总:</th>
                            <td id="fee_${unit.id}_amount"></td>
                            <td id="fee_${unit.id}_fix_value"></td>
                            <td colspan="5">&nbsp;</td>
                        </tr>
                    </table>
                #{/else}
            </td>
        </tr>
    #{/list}
    </table>
</div>
