#{extends 'main_full.html'/}
#{set title:'用户管理界面 (' + users.size() + ')'/}
#{set 'moreScripts'}
    #{script 'users/index.coffee'/}
    #{script 'component/notify.coffee'/}
#{/set}

#{flash_alert /}
#{errorMsgs /}
<div class="btn-toolbar" id="btns">
  <div class="btn-group">
    <a href="@{Users.create()}" class="btn btn-success">添加用户</a>
  </div>
</div>
<div class="row-fluid">
  <div class="span12">
    <table class="table table-bordered table-condensed">
      <tr>
        <th>#</th>
        <th>Username</th>
        <th>Email</th>
        <th>Privileges</th>
        <th>Team</th>
        <th>Opened</th>
      </tr>
    #{list items:users, as:'user'}
        #{ifnot user.username == 'root'}
          <tr>
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td data-toggle="toggle">
              <i class="icon-reorder"></i> ${user.email}
            </td>
            <td data-toggle="toggle" data-target="#${user.username}_privileges">
              <i class="icon-reorder"></i> ${user.privileges.size()} 个权限(共 ${privileges.size()} 个)
            </td>
            <td data-toggle="toggle" data-target="#${user.username}_teams">
              <i class="icon-reorder"></i> ${user.teams?.size()} 个TEAM(共 ${teams?.size()} 个)
            </td>
            <td>
                #{yesOrNo f:!user.closed, id:user.id/}
                #{if user.closed}
                  <a href="#" rel="tooltip" placement="top" title="打开此账户" data-userid="${user.id}" id="openUser">Open</a>
                #{/if}
                #{else}
                  <a href="#" rel="tooltip" placement="top" title="关闭此账户" data-userid="${user.id}" id="closeUser">Close</a>
                #{/else}
            </td>
          </tr>


          <tr id="${user.username}_privileges" style="display:none;">
            <td colspan="5">
              <form method="post" action="@{Users.privileges()}" class="privilege_form">
                <table class="table table-bordered table-condensed">
                <tr>
                    #{list items:privileges, as:'up'}
                      <td colspan="${privileges.size() == up_index ? (privileges.size() - (up_index % 8)) : '1'}">
                        <label class="checkbox">
                          <input type="checkbox" name="privilegeId" value="${up.id}" ${user.isHavePrivilege(up) ? 'checked' : ''}>
                          <a href="javascript:;" rel="tooltip" title="${up.name}">${up.memo}</a>
                        </label>
                      </td>
                        #{if up_index % 8 == 0}
                        </tr>
                        <tr>
                        #{/if}
                    #{/list}
                </tr>
                  <tr>
                    <td colspan="8">
                      <input type="hidden" name="id" value="${user.id}">
                      <button class="btn btn-primary">提交</button>
                    </td>
                  </tr>
                </table>
              </form>
            </td>
          </tr>


          <tr id="${user.username}_teams" style="display:none;">
            <td colspan="5">
              <form method="post" action="@{Users.teams()}" class="privilege_form">
                <table class="table table-bordered table-condensed">
                <tr>
                    #{list items:teams, as:'up'}
                      <td colspan="${teams.size() == up_index ? (teams.size() - (up_index % 8)) : '1'}">
                        <label class="checkbox">
                          <input type="checkbox" name="teamId" value="${up.id}" ${user.isHaveTeam(up) ? 'checked' : ''}>
                          <a href="javascript:;" rel="tooltip" title="${up.name}">${up.name}</a>
                        </label>
                      </td>
                        #{if up_index % 8 == 0}
                        </tr>
                        <tr>
                        #{/if}
                    #{/list}
                </tr>
                  <tr>
                    <td colspan="8">
                      <input type="hidden" name="id" value="${user.id}">
                      <button class="btn btn-primary">提交</button>
                    </td>
                  </tr>
                </table>
              </form>
            </td>
          </tr>
        #{/ifnot}
    #{/list}
    </table>
  </div>
</div>


