#{extends 'main_full.html'/}
#{set title:"质检任务列表 (${tasks.size()})" /}
#{set 'moreScripts'}
    #{script 'component/pagination.coffee'/}
    #{script 'checktasks/checklist.coffee'/}
#{/set}

#{info_row}
<ul>
  <li><strong>质检任务列表</strong></li>
</ul>
#{/info_row}
#{flash_alert /}
#{errorMsgs /}

#{form @CheckTasks.checklist(), class:'search_form'}
<div class="row-fluid">
  <div class="span12">
    <div class="input-append input-prepend inline">
      <span class="add-on">From:</span>
      <input type="date" style="width:90px;" name="p.from" value="${p.from.date()}">
      <span class="add-on">To:</span>
      <input type="date" style="width:90px;" name="p.to" value="${p.to.date()}">
    </div>

    <select name="p.dateType" class="inline" style="width:120px;">
        #{list items:models.view.post.CheckTaskPost.DATE_TYPES, as:'t'}
          <option ${t._1 == p.dateType ? 'selected' : ''} value="${t._1}">${t._2}</option>
        #{/list}
    </select>

    <select name="p.checkstat" class="inline">
      <option value="">质检状态</option>
        #{list items:models.qc.CheckTask.statTypes(), as:'s'}
          <option value="${s}" ${p.checkstat == s ? 'selected' : ''}>${s.label()}</option>
        #{/list}
    </select>

    <select name="p.result" class="inline">
      <option value="">是否合格</option>
        #{list items:models.qc.CheckTask.resultTypes(), as:'r'}
          <option value="${r}" ${p.result == r ? 'selected' : ''}>${r.label()}</option>
        #{/list}
    </select>

    <select name="p.isTimeout" class="inline">
      <option value="">是否超时</option>
        #{list items:[true, false], as:'r'}
          <option value="${r}" ${p != null && p.isTimeout == r.toString() ? 'selected' : ''}>
          ${r ? '超时' :'正常'}
          </option>
        #{/list}
    </select>

    <select name="p.checkor" class="inline">
      <option value="">质检员</option>
        #{list items:users, as:'user'}
          <option value="${user.username}" ${p.checkor == user.username? 'selected': ''}>${user.username}</option>
        #{/list}
    </select>

    <select name="p.shipType" class="inline" style="width:82px;">
      <option value="">运输方式</option>
        #{list items:models.procure.Shipment.T.values(), as:'t'}
          <option ${t == p.shipType ? 'selected' : ''} value="${t.name()}">${t.label()}</option>
        #{/list}
    </select>

    <select name="p.cooperatorId" class="inline selectize" style="width: 120px;">
      <option value="">供应商</option>
        #{list items:cooperators, as:'sp'}
          <option ${sp.id == p.cooperatorId ? 'selected' : ''} value="${sp.id}">${sp.name}</option>
        #{/list}
    </select>

    <div class="input-prepend input-append inline">
      <span class="add-on"><i class="icon-search"></i></span>
      <input style="width:100px" type="text" class="input-xxlarge" name="p.search" value="${p.search}"
             rel="popover" content="支持搜索: 质检任务 ID、物料计划 ID、收货记录 ID、SKU、产品名称、FnSku">
      <input type="hidden" name="p.page" value="${p.page}">
      <button class="btn btn-primary" data-loading>搜索</button>
    </div>
  </div>
</div>
#{/form}

<div class="row-fluid">
  <div class="span12" id="check_div">
    <table id="check_table" class="table table-condensed table-bordered dataTable">
      <tr>
        <th>ID</th>
        <th>质检状态</th>
        <th>预计运输时间</th>
        <th>是否超时</th>
        <th>操作</th>
        <th>收货记录</th>
        <th>收货数量</th>
        <th>物料计划</th>
        <th>SKU</th>
        <th>产品名称</th>
        <th>FnSku</th>
        <th>供应商</th>
        <th>FBA</th>
        <th>去往仓库</th>
        <th>运输方式</th>
        <th>创建时间</th>
        <th>提交时间</th>
        <th>是否合格</th>
        <th>质检员</th>
        <th>提交人</th>
      </tr>
    #{list items:tasks, as:'task'}
    <tr>
      <td width="1%">${task.id}</td>
      <td width="3.5%">${task.checkstat.label()}</td>
      <td width="4.8%">#{time_tooltip time: task.units.attrs.planShipDate/}</td>
      <td style="text-align:center;background-color:${task.isTimeout() ? '#FAAB3B' : '#51a351'}" width="3.4%">
      ${task.isTimeout() ? '超时' : '正常'}
      </td>
      <td width="3.5%">
          #{if task.checkstat.name() == 'UNCHECK'}
            <a href="@{CheckTasks.show(task.id)}" target="_blank" class="btn btn-mini btn-primary">
              质检
            </a>
          #{/if}
          #{else}
            <a href="@{CheckTasks.show(task.id)}" target="_blank" class="btn btn-mini btn-success">
              查看
            </a>
          #{/else}
      </td>
      <td>
        <a href="/ReceiveRecords/index?p.search=id:${task.receiveRecord?.id}" target="_blank">
        ${task.receiveRecord?.id}
        </a>
      </td>
      <td>${task.receiveRecord?.qty}</td>
      <td>
        <a href="/ProcureUnits/index?p.search=id:${task.units?.id}" target="_blank">
        ${task.units?.id}
        </a>
      </td>
      <td>
        <a href="@{Products.show(task.units?.product?.sku)}" target="_blank">
        ${task.units?.product?.sku}
        </a>
      </td>
      <td width="10%;">${task.units?.product?.abbreviation}</td>
      <td>
          #{set fnsku: task.units?.selling?.fnSku/}
          #{if fnsku != null && fnsku != ""}
            <a href="@{Sellings.sellingLabel(task.units?.selling?.sellingId)}" class="btn btn-success">
            ${fnsku} <i class="icon-download-alt"></i>
            </a>
          #{/if}
      </td>
      <td>
        <a href="@{Cooperators.show(task.units?.cooperator?.id)}" target="_blank">
        ${task.units?.cooperator?.name}
        </a>
      </td>
      <td>${task.units?.fba}</td>
      <td>${task.units?.whouse?.name}</td>
      <td>${task.units?.shipType?.label()}</td>
      <td>#{time_tooltip time: task.creatat, datetime: true/}</td>
      <td>#{time_tooltip time: task.endTime, datetime: true/}</td>
      <td>${task.result?.label()}</td>
      <td>${task.matchChecktor()}</td>
      <td>${task.checkor}</td>
    #{/list}
    </table>
  </div>
</div>

<div class="row-fluid" id="order_list">
  <div class="span12">
  #{if tasks.size() == 0}
    暂时还没有质检任务
  #{/if}
  #{else }
      #{bootstrap_pager pi:p, url:'' /}
  #{/else}
  </div>
</div>
#{records records: elcukRecords/}