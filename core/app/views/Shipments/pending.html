#{script 'shipments/pending.coffee'/}
<!-- 处理需要货运的 ProcureUnit -->
<div class="row" style="min-height:300px;">
    <div class="span6" id="procureUnit">
        <table class="table table-condensed">
            <tr>
                <td>Deliveryment</td>
                <td>剩余量</td>
                <td>SID</td>
                <td>转移数量</td>
                <td>&nbsp;</td>
            </tr>
        #{list items:units, as:'unit'}
            #{set leftQtyTuple:unit.leftTransferQty() /}
            #{set isZero:leftQtyTuple._1 == 0/}
            <tr uid="${unit.id}" style="background:${isZero ? '#eee' : '#fff'}">
                <td>
                    <a href="@{Deliveryments.detail(unit.deliveryment.id)}" target="_blank">${unit.deliveryment.id}</a>
                </td>
                <td>
                    <a rel="popover" trigger='toggle' class="btn btn-mini ${isZero ? 'btn-danger' : 'btn-info'}" data-content="Relate ShipmentId:<br> ${leftQtyTuple._2}">${leftQtyTuple._1}</a>
                </td>
                #{set t3:models.market.Selling.sidT3(unit.sid)/}
                <td>
                    <a href="@{Products.p_detail(t3._1)}" target="_blank">${t3._1}</a>|<a href="@{Sellings.selling(unit.sid)}" target="_blank">${t3._2}
                    |${t3._3}</a></td>
                <td><input class="input-mini" style="padding:0"></td>
                <td>
                    #{if isZero}
                        <i class="icon-lock"></i>
                    #{/if}
                    #{else }
                        <button uid="${unit.id}" class="btn btn-mini btn-success"><i class="icon-arrow-right"></i>
                        </button>
                    #{/else}
                </td>
            </tr>
        #{/list}
        </table>
    </div>
    <div class="span6" id="shipitem">
        <table class="table table-condensed">
            <tr>
                <td>SID</td>
                <td>运输数量</td>
                <td>&nbsp;</td>
            </tr>
        #{list items:s.items, as:'itm'}
            <tr shipitem='${itm.id}'>
                #{set t3:models.market.Selling.sidT3(itm.unit.sid)/}
                <td>
                    <a href="@{Products.p_detail(t3._1)}" target="_blank">${t3._1}</a>|<a href="@{Sellings.selling(itm.unit.sid)}" target="_blank">${t3._2}
                    |${t3._3}</a></td>
                <td>${itm.qty}</td>
                <td>
                    <button class="btn btn-mini"><i class="icon-remove-sign"></i></button>
                </td>
            </tr>
        #{/list}
        </table>
    </div>
</div>

<hr>

<div>
    <table class="table table-condensed table-bordered">
        <tr>
            <td>Id</td>
            <td shipmentId='${s.id}'>${s.id}</td>

            <td>运输方式</td>
            <td>${s.type}</td>

            <td>起始地址</td>
            <td>${s.source}</td>

            <td>目标地址</td>
            <td>${s.target}</td>
        </tr>

        <tr>
            <td>发货时间</td>
            <td>${s.beginDate.date()}</td>
            <td>预计到达时间</td>
            <td>${s.planArrivDate.date()}</td>
            <td>实际到达时间</td>
            <td>${s.arriveDate.date()}</td>
            <td colspan="2">&nbsp;</td>
        </tr>

        <tr>
            <td>计价方式</td>
            <td>${s.pype}</td>
            <td>计价单价</td>
            <td>${s.price}</td>
            <td>计价数量</td>
            <td>${s.pQty}</td>
            <td colspan="2">&nbsp;</td>
        </tr>
    </table>
</div>


<div class="accordion-group">
    <div class="accordion-heading">
        <a class="accordion-toggle" data-toggle="collapse" href="#confirmShipment">快递单确认运输</a>
    </div>

    <div id="confirmShipment" class="accordion-body collapse" style="height:0">
        <table class="table table-condensed">
            <tr>
                <td>快递单号</td>
                <td><input style="padding:0" type="text" name="trckNo" value="${s.trackNo}"></td>

                <td>国际快递商</td>
                <td>
                    <select name="iExpress" size="1">
                    #{list items:models.procure.Shipment.I.values(), as:'i'}
                        <option value="${i}">${i}</option>
                    #{/list}
                    </select>
                    <input type="hidden" name="shipmentId" value="${s.id}">
                </td>
            </tr>
            <tr>
                <td colspan="4">
                    <button class="btn btn-small btn-primary">Confirm Ship</button>
                </td>
            </tr>
        </table>
    </div>
</div>

<!-- 付款信息 -->
#{payment_listPayment items:s.payments /}
<!-- 付款 -->
#{payment_addPayment type:'SHIP', payObjId:s.id /}
