<div class="top">
  <div class="row-fluid">
    <div class="span12">
      <table class="table table-bordered table-condensed paymentInfo">
        <caption class="alert alert-success" style="text-align:left"><h4>运输单费用信息</h4></caption>
        <tr>
          <th>#</th>
          <th class="span2">
            <abbr rel='tooltip' title="黑色: 申请状态; 蓝色: 批准状态; 红色: 驳回状态; 绿色: 支付完成状态">费用类型</abbr>
          </th>
          <th class="span1">币种</th>
          <th>单价</th>
          <th>数量</th>
          <th>平均价</th>
          <th class="span2">总价</th>
          <th>备注</th>
          <th>申请人</th>
          <th class="span3">申请时间</th>
          <th class="span3"></th>
        </tr>
      #{list items:ship.allFees(), as:'fee'}
        <tr id='fee_${fee.id}'>
          <td>${fee.id}</td>
          <td><span class="label ${fee.stateLabel()}">${fee.feeType.nickName}</span></td>
          <td>${fee.currency}</td>
          <td>${fee.unitPrice}</td>
          <td>${fee.unitQty}</td>
          <td>${helper.Currency.CNY.symbol()} ${fee.averagePrice()}</td>
          <td data-shipitemid='${fee.shipItem?.id}'>
          ${fee.amount()}
              #{if fee.shipItem}
                <i class="icon-search"></i>
              #{/if}
          </td>
          <td>${fee.memo}</td>
          <td>${fee.payee.username}</td>
          <td>${fee.createdAt}</td>
          <td>
            <button class="btn btn-mini btn-info">编辑</button>
            <button class="btn btn-mini btn-warning">删除</button>
            <button class="btn btn-mini btn-success">批准</button>
            <button class="btn btn-mini btn-danger">驳回</button>
          </td>
        </tr>
      #{/list}
      </table>
    </div>
  </div>

#{power.ck 'paymentunits.postfromtransport'}
  <div class="row-fluid">
    <div class="span12">
      <form class="form-inline span6 add_payment" method="GET">
        <label>费用类型
            #{select 'fee.feeType.name', items: feeTypes, labelProperty:'nickName', valueProperty:'name', as:'type', class: 'input-small'}#{/select}
        </label>

        <label>币种
            #{select 'fee.currency', items:helper.Currency.values(), class: 'input-small', value: 'CNY'}#{/select}
        </label>

        <label>单价
          <input name="fee.unitPrice" type="number" step="any" class="input-mini" value="0">
        </label>

        <label>数量
          <input name="fee.unitQty" type="number" step="any" class="input-mini" value="1">
        </label>

        <label>总价
          <input type="number" readonly="" class="input-mini amount">
        </label>

        <label>备注
          <textarea name="fee.memo" class="input"></textarea>
        </label>

        <button type="submit" class="btn btn-success" data-url='@{PaymentUnits.fromShipment(ship.id)}'>添加费用</button>
        <button type="submit" class="btn btn-inverse" data-url='@{PaymentUnits.calShipmentLeftDuty(ship.id)}'>
          计算剩余关税
        </button>
      </form>
      <a class="btn btn-info" data-method='POST' data-disable-with='申请中...' href='@{PaymentUnits.applyDutyFromShipment(ship.id)}'>
        计算预交关税
      </a>
    </div>
  </div>
#{/power.ck}
</div>

<div class="modal hide fade" id="popModal"></div>

<script type="text/template" id='form-destroyfee-model-template'>
  <form action="<%= fee.url %>" method="POST" data-method='DELETE'>
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3>删除 <%= fee.id %></h3>
    </div>

    <div class="modal-body">
      <label>原因</label>
      <textarea name="reason" required=""></textarea>
    </div>

    <div class="modal-footer">
      <a href="#" data-dismiss="modal" class="btn">取消</a>
      <button class="btn btn-primary" data-id='<%= fee.id %>' data-disable-with='删除中...'>删除</button>
    </div>
  </form>
</script>

<script type="text/template" id='tr-paymentunit-template'>
  <tr id='fee_<%= fee.id %>'>
    <td><%= fee.id %></td>
    <td><span class='label label-<%= label %>'><%= fee.feeType.nickName %></span></td>
    <td><%= fee.currency %></td>
    <td><%= fee.unitPrice %></td>
    <td><%= fee.unitQty %></td>
    <td><%= fee.averagePrice %></td>
    <td data-shipitemid='<%= fee.shipItem.id %>'>
      <%= fee.amount %>
      <% if(fee.shipItem.id) { %>
      <i class="icon-search"></i>
      <% } %>
    </td>
    <td><%= fee.memo %></td>
    <td><%= fee.payee.username %></td>
    <td><%= fee.createdAt %></td>
    <td>
      <button class="btn btn-mini btn-info">编辑</button>
      <button class="btn btn-mini btn-warning">删除</button>
      <button class="btn btn-mini btn-success">批准</button>
      <button class="btn btn-mini btn-danger">驳回</button>
    </td>
  </tr>
</script>

<script type='text/template' id='tr-edit-paymentunit-template'>
  <tr>
    <td><%= fee.id %></td>
    <td><%= fee.feeType.nickName %></td>
    <td>
    #{select 'fee.currency', items:helper.Currency.values(), class: 'input-small'}#{/select}
    </td>
    <td>
      <input type="number" step='any' class="input-mini" name='fee.unitPrice' value="<%= fee.unitPrice %>">
    </td>
    <td>
      <input type="number" step='any' class="input-mini" name="fee.unitQty" value="<%= fee.unitQty %>">
    </td>
    <td>系统计算得出</td>
    <td>
      <input type="number" readonly="" class="input-mini" class="amount" value="<%= fee.amount%>">
    </td>
    <td>
      <textarea name="fee.memo"><%= fee.memo %></textarea>
    </td>
    <td><%= fee.payee.username %></td>
    <td><%= fee.createdAt %></td>
    <td>
      <button class="btn btn-mini btn-success">更新</button>
      <button class="btn btn-mini btn-danger">取消</button>
    </td>
  </tr>
</script>

<script type="text/template" id="form-deny-paymentunit-template">
  <form action="<%= form.url %>" method="POST" data-feeid="<%= form.id %>">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3><span class="text-info"><%= form.title %></span></h3>
    </div>
    <div class="modal-body">
      <div class="row-fluid">
        <label for="model_reason">原因</label>
        <textarea rows="3" class="span12" name="reason"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <input type="submit" class="btn btn-danger deny-paymentunit" data-disable-with='提交中...' value="驳回">
    </div>
  </form>
</script>

<script type="text/template" id="shipItem-template">
  <label>#: <%= itm.id %></label>
  <label>SKU: <%= itm.unit.sku %></label>
  <label>FBA: <%= itm.unit.fba.shipmentId %></label>
  <label>Qty: <%= itm.qty %></label>
  <label>Recived: <%= itm.recivedQty %></label>
  <label>ShipDate: <%= itm.shipDate %></label>
</script>