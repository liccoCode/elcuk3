#{extends 'main_full.html' /}
#{set title:"运输单 #" + ship.id /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'shipments/show.coffee'/}
#{/set}

#{errorMsgs /}

#{info_row title:'采购单信息 <i class="icon-caret-down"></i>'.raw() /}
<div class="row-fluid">
  <div class="span12">
  #{render './_shipment.html', ship: ship, whouses: whouses, shippers: shippers/}
  </div>
</div>

#{flash_alert /}

#{shipmentWorkflow state: ship.state/}

<!-- 时间 -->
<div class="row-fluid">
  <div class="span12">
  #{if ship.dates.atPortDate}
    <div class="span2">
      <dl class="dl-horizontal">
        <dt>平均 运输 天数</dt>
        <dd>从系统中来</dd>
        <dt>实际 运输 天数</dt>
        <dd>${ship.dates.atPortDate - ship.dates.beginDate} 天</dd>
      </dl>
    </div>
  #{/if}
  #{if ship.dates.pickGoodDate}
    <div class="span2">
      <dl class="dl-horizontal">
        <dt>平均 清关 天数</dt>
        <dd>从系统中来</dd>
        <dt>实际 清关 天数</dt>
        <dd>${ship.dates.pickGoodDate - ship.dates.atPortDate} 天</dd>
      </dl>
    </div>
  #{/if}
  #{if ship.dates.bookDate}
    <div class="span2">
      <dl class="dl-horizontal">
        <dt>平均 提货 天数</dt>
        <dd>从系统中来</dd>
        <dt>实际 提货 天数</dt>
        <dd>${ship.dates.bookDate - ship.dates.pickGoodDate} 天</dd>
      </dl>
    </div>
  #{/if}
  #{if ship.dates.deliverDate}
    <div class="span2">
      <dl class="dl-horizontal">
        <dt>平均 预约 天数</dt>
        <dd>从系统中来</dd>
        <dt>实际 预约 天数</dt>
        <dd>${ship.dates.deliverDate - ship.dates.bookDate} 天</dd>
      </dl>
    </div>
  #{/if}
  #{if ship.dates.receiptDate}
    <div class="span2">
      <dl class="dl-horizontal">
        <dt>平均 派送 天数</dt>
        <dd>从系统中来</dd>
        <dt>实际 派送 天数</dt>
        <dd>${ship.dates.receiptDate - ship.dates.deliverDate} 天</dd>
      </dl>
    </div>
  #{/if}
  #{if ship.dates.inbondDate}
    <div class="span2">
      <dl class="dl-horizontal">
        <dt>平均 入库等待 天数</dt>
        <dd>从系统中来</dd>
        <dt>实际 入库等待 天数</dt>
        <dd>${ship.dates.inbondDate - ship.dates.receiptDate} 天</dd>
      </dl>
    </div>
  #{/if}
  </div>
</div>

<div class="row-fluid" id="btnFucs">
  <div class="btn-toolbar">
  #{if ship.state == models.procure.Shipment.S.PLAN}
    <a href="@{Shipments.confirm(ship.id, false)}" data-confirm="确认操作?" data-method="POST"
       class="btn  btn-warning" data-disable-with="确认中...">
      确认运输单
    </a>
  #{/if}
  #{if ship.state == models.procure.Shipment.S.CONFIRM}
    <a href="@{Shipments.confirm(ship.id, true)}" data-confirm="确认操作?" data-method="POST"
       class="btn btn-warning" data-disable-with="确认中...">
      取消确认运输单
    </a>
  #{/if}
  #{power.ck "shipments.beginship"}
      #{if ship.state == models.procure.Shipment.S.CONFIRM}
        <button class="btn btn-success func" url="@{Shipments.beginShip(ship.id)}">
          开始运输
        </button>
      #{/if}
  #{/power.ck}

  #{if ship.type != models.procure.Shipment.T.EXPRESS}
    <a class="btn btn-warning" href="@{Shipments.revertState(ship.id)}" data-method='DELETE'
       data-confirm='确认操作?' data-disable-with='返回中...'>
      回到前一个状态
    </a>
      #{if ship.state == models.procure.Shipment.S.SHIPPING}
        <button class="btn btn-success func" url="@{Shipments.landPort(ship.id)}">
          运输到港
        </button>
      #{/if}
      #{if ship.state == models.procure.Shipment.S.CLEARANCE}
        <button class="btn btn-success func" url="@{Shipments.pickGoods(ship.id)}">
          开始提货
        </button>
      #{/if}
      #{if ship.state == models.procure.Shipment.S.PACKAGE}
        <button class="btn btn-success func" url="@{Shipments.booking(ship.id)}">
          与 Amazon 预约
        </button>
      #{/if}
      #{if ship.state == models.procure.Shipment.S.BOOKED}
        <button class="btn btn-success func" url="@{Shipments.deliverying(ship.id)}">
          派送
        </button>
      #{/if}
      #{if ship.state == models.procure.Shipment.S.DELIVERYING}
        <button class="btn btn-success func" url="@{Shipments.receipt(ship.id)}">
          签收
        </button>
      #{/if}
  #{/if}
  #{if ship.state == models.procure.Shipment.S.RECEIPTD}
    <a href="@{Shipments.inbounding(ship.id)}" class="btn btn-success"
       data-method='POST' data-disable-with='更新中...' data-confirm='确认操作?'>
      入库中
    </a>
  #{/if}
    <div class="modal hide fade" id="funcsForm">
      <form action="#" method="POST">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">×</button>
          <h4>设置时间</h4>
        </div>
        <div class="modal-body">
          <label>日期:</label>
          <input type="date" name="date" date-format='yyyy-MM-dd'>
          <label>时间:</label>
          <input type="time" name="time">
        </div>
        <div class="modal-footer">
          <a href="#" class="btn" data-dismiss="modal">Close</a>
          <button href="#" class="btn btn-primary" data-disable-with="更新中..." data-confirm="确认操作?">
            <span id="action">Save Changes</span>
          </button>
        </div>
      </form>
    </div>


  #{power.ck 'shipments.cancel'}
      #{if ship.state == models.procure.Shipment.S.PLAN}
        <a href="@{Shipments.cancel(ship.id)}" class="btn btn-danger" data-confirm="确认取消运输?"
           data-method="DELETE" data-disable-with="取消中...">
          取消运输单
        </a>
      #{/if}
  #{/power.ck}
  </div>
</div>


#{success_row title:'运输项目' /}
<form action="@{ShipItems.adjust(ship.id, ship.id)}" method="POST" id="adjust_shipitems">

  <div class="row-fluid">
    <div class="span12">
    #{render './_shipitem.html', items: ship.items/}
    </div>
  </div>
  <div class="row-fluid">
    <div class="span3">
      <input type="text" name="shipmentId" placeholder="ShipmentId" style="margin-bottom:0">

      <div class="btn-group">
        <button class="btn" id="previewBtn"><i class="icon-file-alt"></i> 预览</button>
        <button class="btn btn-success adjust" data-disable-with='调整中...' data-confirm="确认调整?">
          <i class="icon-adjust"></i>
          调整
        </button>
      </div>
    </div>

    <div class="span9" id="preview">
    </div>
  </div>
</form>

<div class="row-fluid" style="margin-top:20px">
  <div class="span6">
  #{records records:records/}
  </div>

  <div class="span6">
    <div class="row-fluid">
      <div class="span12">
        <h4 class="text-warning">
          运输进度
          <i class="icon-sort-down"></i>
          &nbsp;
          <a href="@{Shipments.refreshProcuress(ship.id)}" class="btn btn-mini btn-danger" data-method='PUT'>
            <i class="icon-refresh"></i>
          </a>
        </h4>
      </div>
    </div>
    <div id="shipping_details" class="span12">
    #{if ship.iExpressHTML.trim().size() > 0}
    ${ship.iExpressHTML.raw()}
    #{/if}
    #{else }
      还没有跟踪信息
    #{/else}
    </div>
  </div>
</div>

<div class="row-fluid">
  <div class="span12">
    <h4 class="alert alert-success">附件 <i class="icon-sort-down"></i></h4>
  </div>
</div>
<div class="row-fluid">
  <div style="min-height:300px;" class="span12 well" id="dropbox">
    <ul class="thumbnails uploaded"></ul>
    <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
  </div>
</div>
