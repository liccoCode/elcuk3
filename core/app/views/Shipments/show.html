#{extends 'main_full.html' /}
#{set title:"运输单 #" + ship.id /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'shipments/show.coffee'/}
#{/set}

#{errorMsgs /}

#{flash_alert /}

#{info_row title:'采购单信息 <i class="icon-caret-down"></i>'.raw()}
<ul>
    <li>运输单只能运往一个仓库, 其运输的货物也需要是同一个仓库的</li>
    <li>运输单的 Title 处理用来标识系统内的运输单外, 也是 Amazon FBA Shipment 的 Title</li>
    <li>"开始运输" 之后, 会同步 FBA Shipment 标记 Shipped</li>
    <li>"开始运输" 时, 需要将数据补全, 并且开始运输以后, 信息不再可以修改</li>
    <li>在运输单标记开始运输之前, 都可以对信息进行更改,调整</li>
    <li>Fnsku 会在运输单确认以后, 进行一次同步</li>
    <li>总体积单位为 m3 ,总重量单位为 kg; 如果发现数据为 0, 请检查 Product 数据是否填充完整.</li>
    <li>[部分更新] 功能,更新 Comment 与 TrackNo 两部分值</li>
    <li class="text-error">如果拥有 <i style="color:#C09853;" class="icon-star"></i> 标记, 为周期型运输单, 其不允许创建 FBA Shipment,
        而是用来接收 PM 的采购计划.
    </li>
    <li class="text-error">如果是 Create By System, 那么在第一次更新时会设置创建者为更新者</li>
</ul>
#{/info_row}
<div class="row-fluid">
    <div class="span12">
        <form action="@{Shipments.update()}" method="post">
        #{authenticityToken /}
            <table class="table table-condensed table-bordered">
                <tr>
                    <th>Title (Create By ${ship.creater ? ship.creater.username : "System"})</th>
                    <td colspan="3">
                        <input type="text" name="ship.title" class="span10" value="${ship.title ? ship.title : ship.title()}">
                    </td>
                </tr>
                <tr>
                    <th>运输单号</th>
                    <td>
                        <span>${ship.id} ${ship.cycle ? '<i style="color:#C09853;" class="icon-star"></i>'.raw() : ''}</span>
                        <input type="hidden" id="shipmentId" name="ship.id" value="${ship.id}">
                    </td>
                    <th>创建时间</th>
                    <td>${ship.createDate.datetime()}</td>
                </tr>

                <tr>
                    <th>状态</th>
                    <td>${ship.state}</td>
                    <th>运输方式</th>
                    <td>${ship.type}</td>
                </tr>

                <tr>
                    <th>预计运输时间</th>
                    <td>
                        <input type="date" name="ship.planBeginDate" value="${ship.planBeginDate.date()}">
                    #{ifnot ship.state in [models.procure.Shipment.S.PLAN, models.procure.Shipment.S.CANCEL, models.procure.Shipment.S.CONFIRM]}
                        <span class="pull-right">运输时间 #{time_tooltip time:ship.beginDate/}</span>
                    #{/ifnot}
                    </td>
                    <th>预计到库时间</th>
                    <td>
                        <input type="date" name="ship.planArrivDate" value="${ship.planArrivDate.date()}">
                    </td>
                </tr>

                <tr>
                    <th>运输体积(m3)</th>
                    <td>
                        <input type="text" class="input-mini" name="ship.volumn" value="${ship.volumn}">
                    </td>
                    <th>运输重量(kg)</th>
                    <td>
                        <input type="text" class="input-mini" name="ship.weight" value="${ship.weight}">
                    </td>
                </tr>

                <tr>
                    <th>申报价格(单位 USD)</th>
                    <td>
                        <input type="text" class="input-mini" name="ship.declaredValue" value="${ship.declaredValue}">
                    </td>
                    <th>押金(例:预付款)</th>
                    <td>
                        <input type="text" class="input-mini" name="ship.deposit" value="${ship.deposit}">
                    </td>
                </tr>

                <tr>
                    <th>其他费用(例:手续费)</th>
                    <td>
                        <input type="text" class="input-mini" name="ship.otherFee" value="${ship.otherFee}">
                    </td>
                    <th>运费</th>
                    <td>
                        <input type="text" class="input-mini" name="ship.shipFee" value="${ship.shipFee}">
                    </td>
                </tr>

                <tr>
                    <th>Track No.</th>
                    <td>
                        <div class="input-append">
                            <input type="text" class="input-medium" name="ship.trackNo" value="${ship.trackNo}">
                        #{if ship.internationExpress && ship.trackNo}
                            <a href="${ship.internationExpress.trackUrl(ship.trackNo)}" target="_blank" class="btn btn-primary"><i class="icon-external-link"></i></a>
                        #{/if}
                        </div>
                    </td>
                    <th>国际快递商</th>
                    <td>
                        <select name="ship.internationExpress">
                            <option value="">选择快递商</option>
                        #{list items:models.procure.Shipment.Express(), as:'ie'}
                            <option ${ie == ship.internationExpress ? 'selected' : ''} value="${ie}">${ie}</option>
                        #{/list}
                        </select>
                    </td>
                </tr>

                <tr>
                    <th>货代</th>
                    <td>
                        <select name="ship.cooper.id">
                            <option value="">选择货代</option>
                        #{list items:shippers, as:'shiper'}
                            <option ${shiper == ship.cooper ? 'selected' : ''} value="${shiper.id}">${shiper.fullName}</option>
                        #{/list}
                        </select>
                    </td>
                    <th>运输单总重量</th>
                    <td>${ship.totalWeight()} kg</td>
                </tr>

                <tr>
                    <th>仓库</th>
                    <td>
                        <select name="ship.whouse.id">
                            <option value="">选择仓库</option>
                        #{list items:whouses, as:'whouse'}
                            <option ${whouse == ship.whouse ? "selected" : ""} value="${whouse.id}">${whouse.name()}</option>
                        #{/list}
                        </select>
                    </td>
                    <td>计价类型</td>
                    <td>
                        <select name="ship.pype">
                        #{list items:models.procure.Shipment.P.values(), as:'p'}
                            <option ${p == ship.pype ? 'selected' : ''} value="${p.name()}">${p}</option>
                        #{/list}
                        </select>
                    </td>
                </tr>

                <tr>
                    <th>目的地</th>
                    <td>${ship.target}</td>
                    <th>始发地</th>
                    <td>${ship.source}</td>
                </tr>

                <tr>
                    <td colspan="4">
                        <h4>Comment</h4>
                        <textarea rows="8" id="ship_memo" name="ship.memo" class="span12">${ship.memo}</textarea>
                    </td>
                </tr>

                <tr>
                    <td colspan="4">
                    #{set isPlanAndConfirm:ship.state == models.procure.Shipment.S.PLAN || ship.state == models.procure.Shipment.S.CONFIRM /}
                    #{if isPlanAndConfirm}
                        <button class="btn btn-primary">更新</button>
                    #{/if}
                    #{if !isPlanAndConfirm}
                        <button id="ship_comment" class="btn btn-primary">部分更新</button>
                    #{/if}
                    </td>
                </tr>
            #{if ship.arriveDate}
                <tr class="alert alert-success">
                    <th>运输单到达(Amazon 签收)时间</th>
                    <td>#{time_tooltip time:ship.arriveDate/}</td>

                    <td>准点误差</td>
                    #{set diffDays:ship.planArrivDate - ship.arriveDate /}
                    <td style="${diffDays < 0 ? 'color:#B94A48' : ''}">${diffDays} Days</td>
                </tr>
            #{/if}
            </table>
        </form>
    </div>
</div>

<div class="row-fluid">
    <div class="span12" style="margin-bottom:15px;">

    #{ck "shipments.beginship"}
        #{if isPlanAndConfirm}
            <form action="@{Shipments.beginShip()}" method="post" class="pull-left">
                <input type="hidden" name="id" value="${ship.id}">
                #{authenticityToken /}
                <button style="margin-right:10px;" data-confirm="btn" class="btn btn-success">
                    开始运输
                </button>
            </form>
        #{/if}
    #{/ck}
    #{if ship.state == models.procure.Shipment.S.CLEARANCE}
        #{ck "shipments.ensuredone"}
            <form action="@{Shipments.ensureDone()}" method="post">
                <input type="hidden" name="id" value="${ship.id}">
                #{authenticityToken /}
                <button style="margin-right:10px;" data-confirm="btn" class="btn btn-success">确认到货</button>
            </form>
        #{/ck}
    #{/if}
    #{ck 'shipments.cancel'}
        #{if ship.state in [models.procure.Shipment.S.PLAN, models.procure.Shipment.S.CONFIRM]}
            <form action="@{Shipments.cancel()}" method="post">
                <input type="hidden" name="id" value="${ship.id}">
                #{authenticityToken /}
                <button style="margin-right:10px;" data-confirm="btn" class="btn btn-danger">取消运输单</button>
            </form>
        #{/if}
    #{/ck}
    </div>
</div>


#{info_row title:'FBA 列表区'}
<ul>
    <li class="text-error">Amazon 是一次创建, 项目数量不可新创建的(已经创建的数量可更新)</li>
    <li class="text-error">如果需要取消这份 FBA, 将运输的项目从此 FBA 附属的 Shipment 中剔除即可, 但注意, 剔除了就不可再重新添加回来, <strong>FBA 不可修改</strong>
    </li>
</ul>
#{/info_row}
#{list ship.fbas}
    #{render 'Shipments/_fba_shipment.html', fba:_/}
#{/list}

#{success_row title:'运输项目' /}
<div class="row-fluid">
    <div class="span12">
        <form action="" method="post">
        #{authenticityToken /}
            <input type="hidden" name="id" value="${ship.id}">
        #{render 'Shipments/_shipitem.html', items:ship.noFbaItems()/}

        #{if ship.state == models.procure.Shipment.S.PLAN || ship.state == models.procure.Shipment.S.CONFIRM}
            <a href="@{Shipments.shipItem()}/${ship.id}" class="btn btn-primary">查看运输项目</a>
        #{/if}
        #{ck "shipments.deploytoamazon"}
            <button id="create_fba" class="btn btn-warning">创建 FBA</button>
        #{/ck}
        #{ck "shipments.splitshipment"}
            <button id="split_shipment" class="btn btn-warning">分拆运输项目</button>
        #{/ck}
        </form>
    </div>
</div>

#{records records:records/}

<div class="row-fluid">
    <div class="span12 alert alert-danger">
        <h4 data-toggle="toggle" data-target="#shipping_details" style="cursor:pointer;" class="span2">
            运输进程 <i class="icon-reorder"></i>
        </h4>

        <form action="@{Shipments.refreshProcuress()}" method="post" style="margin:0">
            <input type="hidden" name="id" value="${ship.id}">
        #{authenticityToken /}
            <button data-confirm="btn" class="btn btn-danger"><i class="icon-refresh"></i></button>
        </form>
    </div>
</div>
<div class="row-fluid">
    <div id="shipping_details" class="span12" style="display:none;padding-left:30px">
    ${ship.iExpressHTML.raw()}
    </div>
</div>

<div class="row-fluid">
    <div class="span12">
        <h4 class="alert alert-success">附件 <i class="icon-sort-down"></i></h4>
    </div>
</div>
<div class="row-fluid">
    <div style="min-height:300px;" class="span12 well" id="dropbox">
        <ul class="thumbnails uploaded"></ul>
        <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
    </div>
</div>
