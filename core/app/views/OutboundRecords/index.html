#{extends 'main_full.html'/}
#{set title:'出库记录(' + records.size() + ')'/}
#{set 'moreScripts'}
    #{script 'component/pagination.coffee'/}
    #{script 'outboundrecords/index.coffee'/}
#{/set}
#{flash_alert /}

#{info_row}
<ul>
  <li>通过 <strong>[ID]</strong> 搜索出库记录时请使用匹配器: <strong>id:{ID}</strong></li>
  <li>
    <p class="text-error">
      <strong>示例:</strong> id:123, 表示搜索 ID 为 123 的出库记录
      &nbsp;&nbsp;<a href="javascript:void(0)" name="tryIdMatch"><i class="icon-hand-right"></i>试一下</a>
    </p>
  </li>
</ul>
#{/info_row}

<div class="row-fluid">
  <form action="@{OutboundRecords.index()}" method="get" class="search_form" id="search_form">
    <div class="span12">
      <div class="input-prepend input-append inline">
        <span class="add-on">From:</span>
        <input type="date" name="p.from" value="${p.from.date()}">
        <span class="add-on">To:</span>
        <input type="date" name="p.to" value="${p.to.date()}">
      </div>

      <select name="p.dateType" class="inline">
      #{list items:models.view.post.OutboundRecordPost.DATE_TYPES, as:'t'}
        <option ${t._1 == p.dateType ? 'selected' : ''} value="${t._1}">${t._2}</option>
      #{/list}
      </select>

      <select name="p.type" class="inline">
        <option value="">出库类别</option>
      #{list items:models.whouse.OutboundRecord.T, as:'t'}
        <option ${t == p.type ? 'selected' : ''} value="${t.name()}">${t.label()}</option>
      #{/list}
      </select>

      <select name="p.state" class="inline">
        <option value="">状态</option>
      #{list items:models.whouse.OutboundRecord.S, as:'s'}
        <option ${s == p.state ? 'selected' : ''} value="${s.name()}">${s.label()}</option>
      #{/list}
      </select>

      <select name="p.shipType" class="inline">
        <option value="">运输方式</option>
      #{list items:models.procure.Shipment.T, as:'t'}
        <option ${t == p.shipType ? 'selected' : ''} value="${t.name()}">${t.name()}</option>
      #{/list}
      </select>

      <select name="p.market" class="inline">
        <option value="">去往国家</option>
      #{list items:models.market.M.amazonVals(), as:'m'}
        <option ${m == p.market ? 'selected' : ''} value="${m.name()}">${m.marketAndWhouseMapping()}</option>
      #{/list}
      </select>

      <div class="input-prepend input-append inline">
        <span class="add-on"><i class="icon-search"></i></span>
        <input type="text" name="p.search" placeholder="出库对象编码 Or FBA" value="${p.search}" style="width:
              230px;">
        <input type="hidden" name="p.page" value="${p.page}">
        <button class="btn btn-primary" data-loading>搜索</button>
      </div>

      <div class="inline">
        <a href="@{OutboundRecords.blank()}" target="_blank" class="btn btn-success inline">添加其他出库</a>
        <a class="btn btn-info inline" href="javascript:void(0)" id="download_excel">导出</a>
        <a target="_blank" class="btn btn-warning inline" name="confirm">确认出库</a>
      </div>
    </div>
  </form>

  <form action="javascript:void(0)" name="confirm_form">
    <div class="span12" style="overflow: auto;">
      <table class="table table-condensed table-bordered" style="width:2810px;">
        <tr>
          <th rowspan="2">
            <label class="checkbox">
              <input type="checkbox" id="outboundrecord_check_all">
            </label>
          </th>
          <th rowspan="2" style="width:30px;">ID</th>
          <th rowspan="2" style="width:60px;">出库类别</th>
          <th rowspan="2" style="width:50px;">状态</th>
          <th rowspan="2" style="width:40px;">出库计划ID</th>
          <th rowspan="2" style="width:40px;">采购计划ID</th>
          <th rowspan="2" style="width:120px;">SKU</th>
          <th rowspan="2" style="width:110px;">产品名称</th>
          <th rowspan="2" style="width:110px;">变更情况</th>
          <th rowspan="2" style="width:100px;">FBA</th>
          <th rowspan="2" style="width:80px;">预计运输时间</th>
          <th rowspan="2" style="width:40px;">预计出货数量</th>
          <th rowspan="2" style="width:60px;">实际出货数量</th>
          <th rowspan="2" style="width:70px;">去往国家</th>
          <th rowspan="2" style="width:70px;">运输方式</th>
          <th rowspan="2" style="width:120px;">去往仓库</th>
          <th rowspan="2" style="width:80px;">出库对象</th>
          <th colspan="6" style="width:380px;">主箱</th>
          <th colspan="6" style="width:380px;">尾箱</th>
          <th rowspan="2" style="width:80px;">报关类型</th>
          <th rowspan="2" style="width:80px;">供应商</th>
          <th rowspan="2" style="width:60px;">收货记录ID</th>
          <th rowspan="2" style="width:80px;">创建时间</th>
          <th rowspan="2" style="width:80px;">完成时间</th>
          <th rowspan="2" style="width:160px;">备注</th>
        </tr>
        <tr>
          <th>
            <abbr title="主箱收了多少箱货">箱数</abbr>
          </th>
          <th>
            <abbr title="主箱每箱有多少货">数量</abbr>
          </th>
          <th>
            <abbr title="主箱每箱的重量是多少">重量(kg)</abbr>
          </th>
          <th>
            <abbr title="主箱每箱长多少">长(cm)</abbr>
          </th>
          <th>
            <abbr title="主箱每箱宽多少">宽(cm)</abbr>
          </th>
          <th>
            <abbr title="主箱每箱高多少">高(cm)</abbr>
          </th>
          <th>
            <abbr title="尾箱收了多少箱货">箱数</abbr>
          </th>
          <th>
            <abbr title="尾箱每箱有多少货">数量</abbr>
          </th>
          <th>
            <abbr title="尾箱每箱的重量是多少">重量(kg)</abbr>
          </th>
          <th>
            <abbr title="尾箱每箱长多少">长(cm)</abbr>
          </th>
          <th>
            <abbr title="尾箱每箱宽多少">宽(cm)</abbr>
          </th>
          <th>
            <abbr title="尾箱每箱高多少">高(cm)</abbr>
          </th>
        </tr>
      #{list items: records, as: 'r'}
        <tr>
            #{set attrs: r.stockObj.attributes()/}
          <td>
            <label class="checkbox">
              <input type="checkbox" name="rids" value="${r.id}" class="outboundrecord">
            </label>
          </td>
          <td>${r.id}</td>
          <td>${r.type.label()}</td>
          <td>${r.state.label()}</td>
          <td>
              #{if r.shipPlan != null}
                <a href="@{ShipPlans.show(r.shipPlan.id)}" target="_blank">${r.shipPlan.id}</a>
              #{/if}
          </td>
          <td>
              #{set procureunitId: r.shipPlan != null ? r.shipPlan?.unit?.id : attrs.get('procureunitId')/}
              #{if procureunitId}
                <a href="/ProcureUnits/index?p.search=${procureunitId}" target="_blank">
                ${procureunitId}
                </a>
              #{/if}
          </td>
          <td>
            <a href="${r.stockObj.showStockObjLink()}" target="_blank">${r.stockObj.stockObjId}</a>
          </td>
          <td title="${r.stockObj?.name()}">
              #{if r.stockObj?.name().length() <= 20}
                ${r.stockObj?.name()}
              #{/if}
              #{else }
                ${r.stockObj?.name().substring(0,20)}...
              #{/else}
          </td>
          <td title="${r.shipPlan?.memo}">
              #{if r.shipPlan?.memo?.length() <= 7}
                <b>${r.shipPlan?.memo}</b>
              #{/if}
              #{else }
              ${r.shipPlan?.memo.substring(0,7)}...
              #{/else}
          </td>
          <td>${attrs.get('fba')}</td>
          <td>${attrs.get('planBeginDate')?.substring(0,10)}</td>
          <td>${r.planQty}</td>
          <td><input type="text" name="qty" value="${r.qty}" style="width:45px;"></td>
          <td>${attrs.get('whouseName')}</td>
          <td>${r.shipPlan?.shipType?.label()}</td>
          <td>
            <select name="whouse" style="width: 100px;" data-value="${r.whouse?.name}">
              <option value="">仓库</option>
                #{list items:r.availableWhouses(), as:'whouse'}
                  <option ${whouse.id == r.whouse?.id ? 'selected' : ''} value="${whouse.id}">
                  ${whouse.name}
                  </option>
                #{/list}
            </select>
          </td>
          <td>
            <select name="targetId" style="width: 100px;" data-value="${r.targetName()}" data-type="${r.type?.name()}">
              <option value=""></option>
                #{if r.type.name() ==  'Normal' || r.type.name() == 'B2B'}
                    #{list items:shippers, as: 'ship'}
                      <option ${ship.id.toString() == r.targetId ? 'selected' : ''} value="${ship.id}">
                      ${ship.name}
                      </option>
                    #{/list}
                #{/if}
                #{elseif r.type.name() == 'Refund'}
                    #{list items:suppliers, as: 'ship'}
                      <option ${ship.id.toString() == r.targetId ? 'selected' : ''} value="${ship.id}">
                      ${ship.name}
                      </option>
                    #{/list}
                #{/elseif}
                #{elseif r.type.name() == 'Process'}
                  <option ${r.targetId == '品拓生产部' ? 'selected' : ''} value="品拓生产部">
                    品拓生产部
                  </option>
                #{/elseif}
                #{elseif r.type.name() == 'Sample'}
                    #{list items: ["质检部", "采购部", "运营部", "研发部", "生产部"], as: 'target'}
                      <option ${r.targetId == target ? 'selected' : ''} value="${target}">
                      ${target}
                      </option>
                    #{/list}
                #{/elseif}
                #{elseif r.type.name() == 'Other'}
                  <option selected value="${r.targetId}">${r.targetId}</option>
                #{/elseif}
            </select>
          </td>
          <td><input type="text" name="mainBox.boxNum" value="${r.mainBox?.boxNum}" style="width:40px;"></td>
          <td><input type="text" name="mainBox.num" value="${r.mainBox?.num}" style="width:40px;"></td>
          <td>
            <input type="text" name="mainBox.singleBoxWeight" value="${r.mainBox?.singleBoxWeight}" style="width:40px;">
          </td>
          <td><input type="text" name="mainBox.length" value="${r.mainBox?.length}" style="width:40px;"></td>
          <td><input type="text" name="mainBox.width" value="${r.mainBox?.width}" style="width:40px;"></td>
          <td><input type="text" name="mainBox.height" value="${r.mainBox?.height}" style="width:40px;"></td>
          <td><input type="text" name="lastBox.boxNum" value="${r.lastBox?.boxNum}" style="width:40px;"></td>
          <td><input type="text" name="lastBox.num" value="${r.lastBox?.num}" style="width:40px;"></td>
          <td>
            <input type="text" name="lastBox.singleBoxWeight" value="${r.lastBox?.singleBoxWeight}" style="width:40px;">
          </td>
          <td><input type="text" name="lastBox.length" value="${r.lastBox?.length}" style="width:40px;"></td>
          <td><input type="text" name="lastBox.width" value="${r.lastBox?.width}" style="width:40px;"></td>
          <td><input type="text" name="lastBox.height" value="${r.lastBox?.height}" style="width:40px;"></td>
          <td>
            <select style="width:80px;" name="clearanceType">
                #{list items:models.procure.DeliverPlan.CT , as:'c'}
                  <option value="${c.name()}"
                      #{if r.clearanceType?.name()==c.name()} selected #{/if}>${c.label()}
                  </option>
                #{/list}
            </select>
          </td>
            #{set receiveRecord: r.receiveRecord()/}
          <td>
              #{if receiveRecord != null && receiveRecord.procureUnit != null}
                <a href="@{Cooperators.show(receiveRecord.procureUnit?.cooperator?.id)}" target="_blank">
                ${receiveRecord.procureUnit?.cooperator?.name}
                </a>
              #{/if}
          </td>
          <td>
              #{if receiveRecord != null}
                <a href="/ReceiveRecords/index?p.search=id:${receiveRecord.id}" target="_blank">
                ${receiveRecord.id}
                </a>
              #{/if}
          </td>
          <td>${r.createDate.datetime()}</td>
          <td>${r.outboundDate.datetime()}</td>
          <td>
            <input type="text" name="memo" value="${r.memo}" style="width: 150px;">
            <input type="hidden" name="state" value="${r.state.name()}">
          </td>
        </tr>
      #{/list}
      </table>
    </div>
  </form>

  <div class="row-fluid" id="order_list">
    <div class="span12">
    #{if records.size() == 0}
      暂时还没有出库记录
    #{/if}
    #{else }
        #{bootstrap_pager pi:p, url:'' /}
    #{/else}
    </div>
  </div>

#{records records: elcukRecords/}
</div>