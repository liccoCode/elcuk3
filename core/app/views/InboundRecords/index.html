#{extends 'main_full.html'/}
#{set title:'入库记录(' + records.size() + ')'/}
#{set 'moreScripts'}
    #{script_cdn name: 'component/pagination.coffee'/}
    #{script_cdn name: 'inboundrecords/index.coffee'/}
#{/set}
#{flash_alert /}

#{info_row}
<ul>
  <li>
    通过 <strong>[ID]</strong> 搜索入库记录时请使用匹配器: <strong>id:{ID}</strong>
  </li>
  <li>
    <p class="text-error">
      <strong>示例:</strong> id:123, 表示搜索 ID 为 123 的入库记录
      &nbsp;&nbsp;<a href="javascript:void(0)" name="tryIdMatch"><i class="icon-hand-right"></i>试一下</a>
    </p>
  </li>
</ul>
#{/info_row}

<div class="row-fluid">
  <form action="@{InboundRecords.index()}" method="get" class="search_form" id="search_form">
    <div class="span12">
      <div class="input-prepend input-append inline">
        <span class="add-on">From:</span>
        <input type="date" name="p.from" value="${p.from.date()}">
        <span class="add-on">To:</span>
        <input type="date" name="p.to" value="${p.to.date()}">
      </div>

      <select name="p.origin" class="inline">
        <option value="">入库来源</option>
      #{list items:models.whouse.InboundRecord.O, as:'o'}
        <option ${o == p.origin ? 'selected' : ''} value="${o.name()}">${o.label()}</option>
      #{/list}
      </select>

      <select name="p.state" class="inline">
        <option value="">状态</option>
      #{list items:models.whouse.InboundRecord.S, as:'s'}
        <option ${s == p.state ? 'selected' : ''} value="${s.name()}">${s.label()}</option>
      #{/list}
      </select>

      <div class="input-prepend input-append inline">
        <span class="add-on"><i class="icon-search"></i></span>
        <input type="text" name="p.search" placeholder="质检任务 ID Or 物料 ID" value="${p.search}" style="width:
        240px;">
        <input type="hidden" name="p.page" value="${p.page}">
        <button class="btn btn-primary" data-loading>搜索</button>
      </div>

      <div class="inline">
        <a href="@{InboundRecords.blank()}" target="_blank" class="btn btn-success inline">添加其他入库</a>
        <a target="_blank" class="btn btn-info inline" name="confirm">确认入库</a>
      </div>
    </div>
  </form>

  <form action="@{InboundRecords.confirm()}" name="confirm_form">
    <div class="span12">

      <table class="table table-condensed table-bordered">
        <tr>
          <th>
            <label class="checkbox">
              <input type="checkbox" id="inboundrecord_check_all">
            </label>
          </th>
          <th>ID</th>
          <th>状态</th>
          <th>来源</th>
          <th>质检任务 ID</th>
          <th>物料采购 ID</th>
          <th>产品编码</th>
          <th>产品名称</th>
          <th>FBA</th>
          <th>FnSKU</th>
          <th>FBA 仓库</th>
          <th>运输方式</th>
          <th>质检结果</th>
          <th>预计入库数</th>
          <th>良品入库数</th>
          <th>不良品入库数</th>
          <th>目标仓库</th>
          <th>创建时间</th>
          <th>入库时间</th>
          <th>备注</th>
        </tr>
      #{list items: records, as: 'r'}
        <tr>
            #{set attrs: r.stockObj.attributes()/}
          <td>
            <label class="checkbox">
              <input type="checkbox" name="rids" value="${r.id}" class="inboundrecord">
            </label>
          </td>
          <td>${r.id}</td>
          <td>${r.state?.label()}</td>
          <td>${r.origin?.label()}</td>
          <td>
            <a href="@{CheckTasks.show(r.checkTask?.id)}">${r.checkTask?.id}</a>
          </td>
          <td>
              #{if attrs.containsKey('procureunitId')}
                <a href="/ProcureUnits/index?p.search=id:${attrs.get('procureunitId')}" target="_blank">
                ${attrs.get('procureunitId')}
                </a>
              #{/if}
          </td>
          <td>
            <a href="${r.stockObj?.showStockObjLink()}" target="_blank">${r.stockObj?.stockObjId}</a>
          </td>
          <td style="max-width: 280px;">${r.stockObj?.name()}</td>
          <td>${attrs.get('fba')}</td>
          <td style="min-width:130px;">
            <a href="${r.stockObj?.sellingLabelLink()}" class="btn btn-success">
            ${r.stockObj?.fnsku()} <i class="icon-download-alt"></i>
            </a>
          </td>
          <td>${attrs.get('whouseName')}</td>
          <td>${attrs.get('shipType')}</td>
          <td>${r.checkTask?.result?.label()}</td>
          <td>${r.planQty}</td>
          <td>
            <input type="text" name="qty" value="${r.qty}" style="width:45px;">
          </td>
          <td>
            <input type="text" name="badQty" value="${r.badQty}" style="width:45px;">
          </td>
          <td>
            <select name="targetWhouse" data-value="${r.targetWhouse?.name}" style="max-width: 100px;">
              <option value="">仓库</option>
                #{list items:whouses, as:'whouse'}
                  <option ${whouse.id == r.targetWhouse?.id ? 'selected' : ''} value="${whouse.id}">
                  ${whouse.name}
                  </option>
                #{/list}
            </select>
          </td>
          <td>#{time_tooltip time: r.createDate, datetime: true/}</td>
          <td>#{time_tooltip time: r.completeDate, datetime: true/}</td>
          <td>
            <input type="text" name="memo" value="${r.memo}">
            <input type="hidden" name="state" value="${r.state.name()}">
          </td>
        </tr>
      #{/list}
      </table>
    </div>
  </form>

  <div class="row-fluid" id="order_list">
    <div class="span12">
    #{if records.size() == 0}
      暂时还没有入库记录
    #{/if}
    #{else }
        #{bootstrap_pager pi:p, url:'' /}
    #{/else}
    </div>
  </div>

#{records records: elcukRecords/}
</div>