#{extends 'main_full.html'/}
#{set title:"出货单 #" + dp.id /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'timeline/timeline_js/timeline-api.js'/}
    #{script 'analyzes/timeline.coffee'/}
    #{script 'deliveryments/show.coffee'/}
    #{script 'deliverplans/show.coffee'/}
#{/set}

#{errorMsgs /}

#{flash_alert /}

<div class="row-fluid">
  <div class="span12">
    <form method="post" id="plan_form">
      <table class="table table-condensed table-bordered">
        <tr>
          <th>Id</th>
          <td>
            <span id="deliverymentId">${dp.id}</span>
            <input type="hidden" name="dp.id" value="${dp.id}">
          </td>

          <th><span style="color:red">*</span>出货单名称</th>
          <td>
            <input type="text" class="span10" name="dp.name" value="${dp.name}" required>
          </td>
        </tr>

        <tr>
          <th><span style="color:red">*</span>供应商</th>
          <td>
            <select name="dp.cooperator.id" class="selectize" style="width:150px;">
              <option>请选择</option>
            #{list items:cooperators, as:'c'}
              <option ${c.id == dp.cooperator?.id} value="${c.id}">${c.name}</option>
            #{/list}
            </select>
          </td>

          <th><span style="color:red">*</span>报关类型</th>
          <td>
            <select name="dp.clearanceType" class="" style="width:90px;">
            #{list items:models.procure.DeliverPlan.CT.values(), as:'ct'}
              <option ${ct == dp.clearanceType} value="${ct.name()}">${ct.label()}</option>
            #{/list}
            </select>
          </td>
        </tr>
        <tr>
          <th><span style="color:red">*</span>创建日期</th>
          <td>
            <input type="date" class="input-medium" name="dp.createDate"
                   value="${dp.createDate.datetime()}">
          </td>

          <th>创建者</th>
          <td>${dp.handler?.username}</td>
        </tr>

        <tr>
          <td colspan="6">
            <h4>备注:</h4>
            <textarea rows="5" name="dp.memo" class="span12">${dp.memo}</textarea>
            <div style="margin-top:10px;">
            #{ifnot dp.isLocked()}
              <a href="javascript:void(0)" class="btn btn-primary" id="plan_update_btn">更新</a>
            #{/ifnot}
              <a href="@{Excels.deliverplans(dp.id)}" class="btn btn-primary" target="_blank"><i
                  class="icon-download-alt"></i>导出出仓单</a>
            </div>
          </td>
        </tr>
      </table>
    </form>
  </div>
</div>


<div class="row-fluid">
  <div class="span12 alert">
    <h4 data-toggle="toggle" data-target="#tl">Timeline <i class="icon-reorder"></i></h4>
  </div>
</div>
<div class="row-fluid">
  <div id="tl" class="span12" style="height:350px;"></div>
</div>

#{success_row title:"已经添加进入[出货单]的[采购单元] "/}
<form action="#" id="bulkpost" method="POST">
  <input type="hidden" name="expressid" id="expressid" value="${expressid}">
  <div class="row-fluid">
    <div class="span12" id="unit_list">
    #{render 'DeliverPlans/_units.html', units: dp.units, key: 'delivery'/}
    </div>
  </div>
  <div class="row-fluid">
    <div class="btn-toolbar">
    #{ifnot dp.isLocked()}
        #{power.ck "products.edit"}
          <a href="javascript:void(0);" data-url='@{DeliverPlans.delunits(dp.id)}' data-method="DELETE"
             id="delunit_form_submit" rel="popover" content="将 DELIVERY 状态的采购计划从采购单中移除出去" placement="right" class="btn btn-warning">
            解除
          </a>
        #{/power.ck}
    #{/ifnot}
    #{power.ck 'fbas.deploytoamazon'}
      <a href="javascript:void(0);" data-url='@{DeliverPlans.deploysToAmazon(dp.id)}' data-method="POST" id="deployFBAs" class="btn btn-success">
        批量创建 FBA
      </a>
    #{/power.ck}
      <a href="javascript:void(0);" data-url="@{DeliverPlans.downloadFBAZIP(dp.id)}" data-method="POST"
         id="downloadFBAZIP" class="btn btn-success" rel="popover" content="将选定的采购单元的 出货FBA
           进行压缩打包 "><i class="icon-download-alt"></i>下载FBA ZIP 包
      </a>
    </div>
  </div>
  <input id='form_method' type="hidden" name="x-http-method-override" value="POST">
#{include 'Deliveryments/box_number_model.html'/}
</form>

#{info_row title:'可添加进入[出货单]的[采购单元]'/}
#{form @DeliverPlans.addunits(dp.id), method: 'POST'}
<div class="row-fluid">
  <div class="span12">
    <input type="hidden" name="dp.id" value="${dp.id}">
      #{render 'DeliverPlans/_units.html', units: plan_units, key: 'plan'/}
  </div>
</div>
<div class="row-fluid">
  <div class="span12">
    <div class="pull-left input-prepend input-append">
      <span class="add-on" rel="popover" content="将 PLAN 状态的采购计划添加到采购单中" placement="right"><i class="icon-question-sign"></i></span>
        #{ifnot dp.isLocked()}
            #{power.ck "products.edit"}
              <button id="plan_form_submit" class="btn btn-primary">添加</button>
            #{/power.ck}
        #{/ifnot}
    </div>
  </div>
</div>
#{/form}

#{records records:records/}

<div class="row-fluid">
  <div class="span12">
    <h4 class="alert alert-success">附件 <i class="icon-sort-down"></i></h4>
  </div>
</div>
<div class="row-fluid">
  <div style="min-height:300px;" class="span12 well" id="dropbox">
    <ul class="thumbnails uploaded"></ul>
  #{power.ck "products.edit"}
    <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
  #{/power.ck}
  </div>
</div>



