#{extends 'main.html'/}
#{set title:'Feedback #' + feedback.orderId /}
#{set 'moreScripts'}
    #{script 'tickets/reviewAndFeedback.coffee'/}
#{/set}

#{set haveTicket:feedback.ticket != null/}
#{set isClosed:feedback.ticket.state == models.support.TicketState.CLOSE/}

#{render 'Tickets/_success.html', success:feedback.ticket.isSuccess/}

<div class="label label-info">Feedback</div>
<div>
    <table class="table table-condensed table-bordered">
        <tr>
            <th>OrderId</th>
            <td>
                <a href="${feedback.orderr.orderLink()}" target="_blank">
                    <i class="icon-external-link"></i> ${feedback.orderId}
                </a>
            </td>
            <th>UserId</th>
            <td>${feedback.orderr.userid}</td>
            <th>Score</th>
            <td>${feedback.score}</td>
        </tr>

        <tr>
            <th>Email</th>
            <td>${feedback.email}</td>
            <th>Market</th>
            <td>${feedback.market}</td>
            <th>OsTicketId</th>
            <td>
            #{if feedback.ticket}
                <a href="${feedback.ticket.osTicketLink()}" target="_blank"><i class="icon-external-link"></i> ${feedback.osTicketId}
                </a>
            #{/if}
            #{else }
            ${feedback.osTicketId}
            #{/else}
            </td>
        </tr>

    #{if haveTicket}
        <tr>
            <th>最后同步时间 <button id="sync_ticket" class="btn btn-mini btn-success"><i class="icon-refresh"></i></button></th>
            <td>${feedback.ticket.lastSyncTime?.since()}</td>
            <th>最后联系客户时间</th>
            <td title="${feedback.ticket.lastResponseTime?.datetime()}">${feedback.ticket.lastResponseTime?.since()}</td>
            <th>客户最后回复时间</th>
            <td title="${feedback.ticket.lastMessageTime?.datetime()}">${feedback.ticket.lastMessageTime?.since()}</td>
        </tr>
        <tr>
            <th rel="popover" content="${feedback.ticket.state.explan()}"><i class="icon-question-sign"></i> State</th>
            <td>${feedback.ticket.state}</td>
            <th>是否成功/删除</th>
            <td>#{yesOrNo f:feedback.ticket.isSuccess /} | #{yesOrNo f:feedback.isRemove/}</td>
            <th>客户回复 / 我方联系</th>
            <td>${feedback.ticket.messageTimes} / ${feedback.ticket.responseTimes}</td>
        </tr>

        <tr>
            <td colspan="6">
                <div class="row-fluid" id="reason_div">
                    <div class="span5">
                        #{list items:feedback.ticket.reasons, as:'tag'}
                            <span rel="popover" content="${tag.memo}" class="reason badge badge-important">${tag.name()}</span>
                        #{/list}
                    </div>

                    <div class="span7">
                        <input type="hidden" id="ticketId" value="${feedback.ticket.id}">
                        #{list items:unTagAndAll._1, as:'unTag'}
                            <span rel="popover" content="${unTag.memo}" class="unTagReason badge badge-info">${unTag.name()}</span>
                        #{/list}
                    </div>
                </div>
            </td>
        </tr>
    #{/if}

        <tr>
            <td colspan="6">
                <div class="row-fluid">
                    <div class="span6">

                        <!-- 此 Ticket 的处理者 -->
                    #{if haveTicket && (feedback.ticket.resolver == null)}
                        <button id="take_it" rel="popover" content="由我[${session.get("username")}]来处理这个 Ticket" class="btn btn-primary">
                            Take It
                        </button>
                    #{/if}
                    #{elseif haveTicket}
                        <span class="badge badge-info">由 <i class="icon-user"></i> ${feedback.ticket.resolver.username.capAll()}
                            处理
                        </span>
                    #{/elseif}

                    #{if haveTicket && !isClosed}
                        <div style="margin:5px 0">
                            <a data-toggle="toggle" data-target="#close_div" class="btn btn-danger">
                                <i class="icon-edit"></i> Close
                            </a>
                        </div>
                    #{/if}
                    </div>

                    <div class="span6">
                    #{list items:feedback.orderr.items, as:'oitm'}
                        <img src="${oitm.selling.listing.picUrls}">
                    #{/list}
                    </div>
                </div>

            #{if haveTicket && !isClosed}
                <div class="row-fluid">
                    <div id="close_div" class="span12" style="display:none;margin-top:10px;">
                        #{render 'Tickets/_close_single.html', reasons:feedback.ticket.reasons/}
                    </div>
                </div>
            #{/if}
            </td>
        </tr>


        <tr>
            <td colspan="6" class="alert alert-info">
                <h4 rel="popover" content="Feedback 的留言" placement="left" width='auto'>
                    <i class="icon-question-sign"></i> Feedback
                </h4>

                <p>${feedback.feedback.raw()}</p>
            </td>
        </tr>
        <tr>
            <td colspan="6" class="alert alert-success">
                <h4 rel="popover" content="系统自行添加的对 Feedback 的记录" placement="left" width='auto'>
                    <i class="icon-question-sign"></i> Feedback Comment
                </h4>

                <p>${feedback.memo.raw()}</p>
            </td>
        </tr>

    #{if haveTicket}
        <tr>
            <td colspan="6" class="alert alert-info">
                <h4 rel="popover" content="系统自行添加的对 Feedback 对应的 Ticket 的记录" placement="left" width='auto'>
                    <i class="icon-question-sign"></i> Ticket Comment
                </h4>

                <p>${feedback.ticket.memo.raw()}</p>
            </td>
        </tr>
    #{/if}
    </table>
</div>

#{if feedback.orderr != null}
    #{render 'Orders/show.html', ord: feedback.orderr, part: true/}
#{/if}
