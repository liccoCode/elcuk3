#{extends 'main_full.html'/}
#{set title:"物料出货单 #" + dp.id /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'materialPlans/edit.js'/}
#{/set}

#{errorMsgs /}
#{flash_alert /}


#{info_row title:'物料出货单信息'/}

<div class="row-fluid">

  <div class="tab-content">
    <div class="tab-pane fade active in" id='currentPage'>
      <form action="@{MaterialPlans.update()}" method="post" name="updateDeliverymentForm" id="updateDeliverymentForm">
        <table class="table table-condensed table-bordered">
          <tr>
            <th>物料出库单ID</th>
            <td><input type="text" id="deliverymentId" name="dp.id" value="${dp?.id}" readonly/></td>
            <th>State</th>
            <td><input type="text" value="${dp?.state?.label()}" readonly></td>
          </tr>
          <tr>
            <th>出库单名称<span style="color:red">*</span></th>
            <td>
              <input type="text" class="span8" name="dp.name" value="${dp.name}" #{if !qtyEdit}readonly#{/if} required>
            </td>
            <th>收货类型<span style="color:red">*</span></th>
            <td>
            #{if qtyEdit}
              <select name="dp.receipt" class="inline" required  id="receipt">
                <option value="">收货类型</option>
                  #{list items:models.material.MaterialPlan.R, as:'c'}
                    <option value="${c.name()}" ${c==dp.receipt?'selected':''}>${c.label()}</option>
                  #{/list}
              </select>
            #{/if}
            #{else }
              <input type="text" value="${dp.receipt.label()}" readonly>
            #{/else}
            </td>
          </tr>
          <tr>
            <th>供应商</th>
            <td>
              <input type="hidden" name="dp.cooperator.id" value="${dp?.cooperator?.id}" #{if !qtyEdit}readonly#{/if} required/>
              <input type="text" value="${dp?.cooperator?.name}" readonly/>
            </td>
            <th>项目名称<span style="color:red">*</span></th>
            <td>
            #{if qtyEdit}
              <select name="dp.projectName" class="inline" required>
                <option value="${brandName}">${brandName}</option>
              </select>
            #{/if}
            #{else }
              <input type="text" name="dp.projectName" value="${dp.projectName}" readonly>
            #{/else}
            </td>
          </tr>

          <tr  #{if receipt }style="display: none" #{/if} id="receiveTr">
            <th>收货方</th>
            <td colspan="3">
            #{if qtyEdit}
              <select name="dp.receiveCooperator.id" class="inline selectize" style="width:220px;" id="outCooperator">
                <option value="">请输入收货供应商代码</option>
                  #{list items:cooperators, as:'cop'}
                    <option #{if dp?.receiveCooperator?.id==cop.id} selected #{/if} value="${cop.id}">${cop.name}</option>
                  #{/list}
              </select>
            #{/if}
            </td>
          </tr>
          <tr>
            <th>目的地</th>
            <td colspan="3">
              <textarea name="dp.address" rows="1" class="input-block-level" id="whouse"
                        #{if !qtyEdit}disabled="disabled"#{/if}>${dp?.address}</textarea>
            </td>
          </tr>

          <tr>
            <th>创建人</th>
            <td>
              <input type="hidden" name="dp.handler.id" value="${dp?.handler?.id}" required/>
              <input type="text" name="dp.handler.username" value="${dp?.handler?.username}" readonly/>
            </td>
            <th>创建日期</th>
            <td>
              <input type="text" readonly class="input-medium" value="${dp.createDate.datetime()}">
            </td>
          </tr>
          <tr>
            <th>备注</th>
            <td colspan="5">
              <textarea name="dp.memo" rows="4" class="input-block-level">${dp?.memo}</textarea>
            </td>
          </tr>
          <tr>
            <td colspan="6">
            #{if dp.apply}
                <a href="@{Applys.material(dp.apply.id)}" class="btn btn-success">${dp.apply.serialNumber}
                  请款单</a>
            #{/if}
              <button class="btn btn-primary" name="create_record">更新</button>
              <a href="@{Excels.materialPlan(dp.id)}" class="btn btn-success" target="_blank"><i
                  class="icon-download-alt"></i>导出物料出货单</a>
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div>
</div>

#{success_row title:"已经添加进入[物料出货单]的[出货单元] "/}
<form action="#" id="bulkpost" method="POST">
  <div class="row-fluid">
    <div class="span12" id="unit_list">
      <table class="table table-condensed table-bordered" id="unit_table">
        <tr>
          <th>#</th>
          <th>物料编码</th>
          <th>物料名称</th>
          <th>采购余量</th>
          <th>交货数量</th>
          <th>Action_签收数量</th>
          <th>项目名称</th>
          <th>创建人</th>
          <th>创建时间</th>
        </tr>
      #{list items:units, as:'unit'}
        <tr class="text-center">
          <td>
            <input type="checkbox" name="pids" value="${unit.id}" class="${tr_key}" id="checkbox_${unit.id}"
                   data-boxnum="" data-num="" data-lastcartonnum="" data-singleboxweight="" data-length=""
                   data-width="" data-height="">
          </td>
          <td>${unit.material?.code}</td>
          <td>${unit.material?.name}</td>
          <td>${unit.material?.surplusConfirmQty()}</td>
          <td>
              #{if qtyEdit}
                <input type="text" name="qty" class="input-medium" value="${unit.qty}">
              #{/if}
              #{else } ${unit.qty} #{/else}
          </td>
          <td>
              #{if unit.receiptQty == 0 && !qtyEdit}
                <a href="javascript:void(0)" name="unitUpdateBtn" class="btn btn-small btn-primary" id="qs_${unit.id}"
                   uid="${unit.id}">签收异常</a>
              #{/if}
              #{else } ${unit.receiptQty} #{/else}
          </td>
          <td>${unit.material?.projectName}</td>
          <td>${unit.handler?.username}</td>
          <td>#{time_tooltip time:unit.createDate /}</td>
        </tr>
      #{/list}
      </table>
    </div>
  </div>

#{if qtyEdit}
  <div class="row-fluid">
    <div class="span12">

      <div class="input-append">
        <button id="delunit_form_submit" class="btn btn-warning" data-url='@{MaterialPlans.delunits(dp.id)}' data-method="DELETE"
                placeHolder="将 DELIVERY 状态的出货计划从出货单中移除出去" data-disable-with='解除中'>
          解除
        </button>
      </div>

      <div class="input-append">
        <input type="text" id="code" placeHolder="物料编码(必须)">
        <button id="addPlanUnitBtn" class="btn btn-success" data-disable-with='添加中'>
          快速添加
        </button>
      </div>

      <div class="input-append">
        <button id="confirmPlanBtn" class="btn btn-primary" data-disable-with='添加中'>
          确认
        </button>
      </div>

    </div>
  </div>
#{/if}
  <input id='form_method' type="hidden" name="x-http-method-override" value="POST">
</form>

#{records records:records/}

<div class="row-fluid">
  <div class="span12">
    <h4 class="alert alert-success">附件 <i class="icon-sort-down"></i></h4>
  </div>
</div>
<div class="row-fluid">
  <div style="min-height:300px;" class="span12 well" id="dropbox">
    <ul class="thumbnails uploaded"></ul>
  #{power.ck "products.edit"}
    <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
  #{/power.ck}
  </div>
</div>

<!--  修改签收数量 弹出div begin   -->
<div id="bom_modal" class="modal hide fade">
  <div class="modal-header">
    <h4>签收数量修改</h4>
  </div>
  <div class="modal-body">
    <form action="@{MaterialPlans.updateMaterialPlanUnit()}" method="post" id="updateUnit_form">
      <input type="hidden" name="unit.id" id="unit_id">
      <table class="table table-condensed table-bordered">
        <tr>
          <th width="30%">实际签收数量</th>
          <td>
            <input type="text" placeHolder="实际签收数量" id="unit_receiptQty" name="unit.receiptQty">
          </td>
        </tr>
      </table>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
    <button class="btn btn-primary" id="submitUpdateBtn">提交</button>
  </div>
</div>
<!--  修改签收数量 弹出div end   -->

<form action="@{MaterialPlans.confirm(dp.id)}" method="post" id="confirm_form">
  <input type="hidden" name="unit.id" value="${dp?.id}" id="unit_id">
</form>


<form action="@{MaterialPlans.addunits(dp.id)}" method="post" id="addunits_form">
  <input type="hidden" name="unit.id" value="${dp?.id}" id="unit_id">
  <input type="hidden" name="code" id="unit_code">
</form>


