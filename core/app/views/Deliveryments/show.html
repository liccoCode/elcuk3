#{extends 'main_full.html'/}
#{set title:"采购单 #" + dmt.id /}
#{set 'moreScripts'}
    #{script 'component/dropUpload.coffee'/}
    #{script 'deliveryments/show.coffee'/}
#{/set}

#{ifErrors }
    #{errorMsgs /}
#{/ifErrors}

#{if flash.success}
<div class="alert alert-success" style="text-align:center;">
    <p>${flash.success}</p>
</div>
#{/if}

#{set isPending: dmt.state == models.procure.Deliveryment.S.PENDING/}
<div class="row-fluid">
    <div class="span12">
        <form action="@{Deliveryments.update()}" method="post">
            <table class="table table-condensed table-bordered">
                <tr>
                    <th>Id</th>
                    <td>
                        <span id="deliverymentId">${dmt.id}</span>
                        <input type="hidden" name="dmt.id" value="${dmt.id}">
                    </td>

                    <th>State</th>
                    <td style="color:${'#' + dmt.state.rgb()}">${dmt.state}</td>

                    <th>CreateDate</th>
                    <td>
                        <input type="text" readonly="" disabled="" class="input-medium" name="dmt.createDate" value="${dmt.createDate.datetime()}">
                    </td>
                </tr>

                <tr>
                    <th>Name</th>
                    <td colspan="2">
                        <input type="text" class="span10" name="dmt.name" value="${dmt.name}">
                    </td>

                    <th>User</th>
                    <td>${dmt.handler.username}</td>
                    <td></td>
                </tr>

                <tr>
                    <td colspan="6">
                        <h3>Memo:</h3>
                        <textarea rows="8" name="dmt.memo" class="span12">${dmt.memo}</textarea>
                        <button class="btn btn-primary">更新</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<div class="row-fluid">
    <div class="span12">
    #{if isPending}
        <form action="@{Deliveryments.confirm()}" method="post" style="display:inline-block;">
            <div class="input-prepend input-append" style="float:left;">
                <span class="add-on" rel="popover" content="确认采购单, 采购单进行确认以后, 才可以在运输单中进行挑选, 并且不再允许添加新的采购计划" placement="right"><i class="icon-question-sign"></i></span>
                <input type="hidden" name="id" value="${dmt.id}">
                <button class="btn btn-primary">确认</button>
            </div>
        </form>
    #{/if}
    #{ck 'root'}
        <form action="@{Deliveryments.cancel()}" method="post" style="display:inline-block;">
            <input type="hidden" name="id" value="${dmt.id}">

            <div class="input-append" style="float:left;margin-left:10px;">
                <input type="text" name="msg" value="${msg}" placeHolder="填写简要关闭的原因">
                <button class="btn btn-danger">取消采购单</button>
            </div>
        </form>
    #{/ck}
    </div>
</div>

<div class="row-fluid">
    <div class="span12">
        <h4 class="alert alert-success">已经添加进入[采购单]的[采购单元] <i class="icon-sort-down"></i></h4>

        <form id="delivery_form" method="post">
            <input type="hidden" name="dmt.id" value="${dmt.id}">
        #{render 'Procures/_unit_list.html', units:dmt.units, checkbox:true, key:'delivery', delivery:true/}
        </form>
    </div>
</div>
<div class="row-fluid">
    <div class="span12">

    #{if isPending}
        <div class="pull-left input-prepend input-append">
            <span class="add-on" rel="popover" content="将 DELIVERY 状态的采购计划从采购单中移除出去" placement="right"><i class="icon-question-sign"></i></span>
            <button id="delunit_form_submit" class="btn btn-warning">解除</button>
        </div>
    #{/if}
    </div>
</div>

<div class="row-fluid">
    <div class="span12">
        <h4 class="alert alert-info">可添加进入[采购单]的[采购单元] <i class="icon-sort-down"></i></h4>

        <form id="plan_form" action="@{Deliveryments.addunits()}" method="post">
            <input type="hidden" name="dmt.id" value="${dmt.id}">
        #{render 'Procures/_unit_list.html', units:plan_units, checkbox:true, key:'plan'/}
        </form>
    </div>
</div>
<div class="row-fluid">
    <div class="span12">
    #{if isPending}
        <div class="pull-left input-prepend input-append">
            <span class="add-on" rel="popover" content="将 PLAN 状态的采购计划添加到采购单中" placement="right"><i class="icon-question-sign"></i></span>
            <button id="plan_form_submit" class="btn btn-primary">添加</button>
        </div>
    #{/if}
    </div>
</div>

<div class="row-fluid">
    <div class="span12 alert">
        <h4><a href="#" rel="tooltip" placement="right" title="操作记录"><i class="icon-question-sign"></i></a> Records
            <i class="icon-sort-down"></i>
        </h4>
    </div>
</div>

<div class="row-fluid">
    <div class="span12">
    #{if records.size() == 0}
        <p class="text-info">暂时没有记录</p>
    #{/if}
    #{list items:records, as:'rcd'}
        <p class="text-info">${rcd.record().raw()}</p>
    #{/list}
    </div>
</div>


<div class="row-fluid">
    <div class="span12">
        <h4 class="alert alert-success">附件 <i class="icon-sort-down"></i></h4>
    </div>
</div>
<div class="row-fluid">
    <div style="min-height:300px;" class="span12 well" id="dropbox">
        <ul class="thumbnails uploaded"></ul>
        <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
    </div>
</div>
