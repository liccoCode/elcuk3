#{extends 'main_full.html' /}
#{set title:dlmt.id /}
#{set 'moreScripts'}
    #{script 'jquery.filedrop.js' /}
    #{script 'jquery.validate.min.js'/}
    #{script 'component/dropUpload.coffee'/}
    #{script 'procures/detail.coffee'/}
#{/set}

<div><span class="label label-info">基础信息</span></div>
<div>
    <table class="table table-condensed table-bordered">
        <tr>
            <td>Id:</td>
            <td id="deliveryId">${dlmt.id}</td>
            <td>State:</td>
            <td style="background:${dlmt.state.color()}">${dlmt.state}</td>
            <td>创建日期</td>
            <td>${dlmt.createDate.format("yyyy-MM-dd hh:mm:ss")}</td>
            <td>User:</td>
            <td>${dlmt.handler.username}</td>
            <td>&nbsp;</td>
            <td class="pull-right">
            #{ck 'root'}
                <button id="cancel_btn" rel="popover" data-content="取消这个 Delivery, 其关联的 ProcureUnit 与 ShipItem 的数量全部变为 0;" placement='left' class="btn btn-small btn-danger">
                    CANCEL
                </button>
            #{/ck}
            </td>
        </tr>

        <tr>
            <td>
                <button id="add_memo" rel="popover" data-content="保存更新 Memo" width="auto" class="btn btn-small btn-primary">
                    Memo
                </button>
            </td>
            <td colspan="9">
                <textarea rows="5" class="span11">${dlmt.memo}</textarea>
            </td>
        </tr>
    </table>
</div>

<div><span class="label label-info">付款信息</span></div>
<div>
#{payment_listPayment items:dlmt.payments /}
#{if !dlmt.isPaymentComplete()}
    #{payment_addPayment type:'DELIVERY', payObjId:dlmt.id /}
#{/if}
</div>

<div><span class="label label-info">ProcureUnits</span></div>
<div id="procure_units">
    <table class="table table-condensed table-bordered">
        <tr>
            <td>#</td>
            <td>计划到库日期</td>
            <td>计划交货日期</td>
            <td>实际交货日期</td>
            <td>确认采购数量</td>
            <td>实际交货数量</td>
            <td>供应商</td>
            <td>Selling</td>
            <td>Msku</td>
            <td>Product</td>
            <td>Price</td>
            <td>金额</td>
            <td>阶段</td>
        </tr>
    #{list items:dlmt.units, as:'unit'}
        <tr data-toggle="collapse" href="#unit_${unit.id}">
            <td>${unit.id}</td>
            <td>${unit.plan.planArrivDate.date()}</td>
            <td>${unit.delivery.planDeliveryDate.date()}</td>
            <td>
                #{if unit.delivery.deliveryDate == null}
                    <span class="label label-warning">还未交货</span>
                #{/if}
                #{else }
                ${unit.delivery.deliveryDate.date()}
                #{/else}
            </td>
            <td>${unit.delivery.ensureQty}</td>
            <td rel="popover" data-content="${unit.comment}" title="Comment">
                #{if unit.delivery.deliveryQty == null}
                    <span class="label label-warning">还未交货</span>
                #{/if}
                #{else }
                ${unit.delivery.deliveryQty}
                #{/else}
            </td>
            <td>${unit.plan.supplier}</td>
            <td>${unit.selling.sellingId}</td>
            <td>${unit.selling.merchantSKU}</td>
            <td>${unit.product.sku}</td>
            <td>${unit.plan.unitPrice} ${unit.plan.currency}</td>
        <td>
        ${unit.delivery.ensureQty * unit.plan.unitPrice}
            #{ifnot unit.delivery.deliveryQty == null}|
            ${unit.delivery.deliveryQty * unit.plan.unitPrice}</td>
            #{/ifnot}
            <td style="background:${unit.stage.color()}">${unit.stage}</td>
        </tr>
        <tr id="unit_${unit.id}" style="display:none;">
            <td colspan="13">
                <form><!-- 用于 jquery.validate 插件的 -->
                    <table class="table table-condensed table-bordered">
                        <tr>
                            <td>Links:</td>
                            <td>
                                #{procure_links unit:unit/}
                            </td>
                            <td>
                                确认采购量 / 预计采购量
                            </td>
                            <td>
                                <span style="color:green;">${unit.delivery.ensureQty}</span> /
                                <span style="color:#24748c;">${unit.plan.planQty}</span>
                            </td>
                        </tr>

                        <tr>
                            <td>实际交货日期</td>
                            <td>
                                <input name="d.deliveryDate" type="date" class="required" placeHolder="实际交货日期" value="${unit.delivery.deliveryDate.date()}">
                            </td>
                            <td>实际交货数量</td>
                            <td>
                                <input type="text" name="d.deliveryQty" class="required" value="${unit.delivery.deliveryQty}">
                                <input type="hidden" name="id" value="${unit.id}">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                留言
                                <textarea rows="4" style="width:99%" name="cmt">${unit.comment}</textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button rel="update_delivery_info_btn" uid="${unit.id}" class="btn btn-small btn-primary">
                                    更新交货信息
                                </button>
                            </td>
                            <td colspan="3"></td>
                        </tr>
                    </table>
                </form>
            </td>
        </tr>
    #{/list}
    </table>
</div>

<div><span style="line-break:strict;" class="label label-info">附件</span></div>
<div style="min-height:300px;background:#eee;" id="dropbox">
    <ul class="thumbnails uploaded"></ul>
    <div class="message" style="height:150px;padding-top:145px;text-align:center;">Drag & Drop</div>
</div>
